<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Prestige Visual System - AR LED Video Wall Visualizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #fff; touch-action: none; -webkit-user-select: none; user-select: none; }
        #startScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #0a0a1a 0%, #0f1a2a 50%, #0a0a0f 100%); z-index: 1000; padding: 20px; }
        .logo-text { font-size: 36px; font-weight: 800; background: linear-gradient(135deg, #00a8ff, #00ffcc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-align: center; margin-bottom: 5px; }
        .logo-subtitle { font-size: 14px; color: rgba(0,200,255,0.7); text-transform: uppercase; letter-spacing: 6px; margin-bottom: 30px; }
        .tagline { font-size: 16px; color: rgba(255,255,255,0.6); margin-bottom: 40px; }
        .features-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 40px; max-width: 350px; }
        .feature-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(0,150,255,0.1); border: 1px solid rgba(0,200,255,0.2); border-radius: 10px; font-size: 13px; }
        #startButton, #demoButton { padding: 16px 40px; font-size: 14px; font-weight: 600; color: #fff; border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; margin: 5px; }
        #startButton { background: linear-gradient(135deg, #0080ff, #00c8aa); }
        #demoButton { background: #444; }
        .demo-note { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 10px; }
        #arView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #000; }
        #videoFeed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #demoBackground { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); display: none; }
        #threeCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #touchLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; touch-action: none; }
        #header { position: absolute; top: 0; left: 0; right: 0; padding: 15px 20px; background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent); z-index: 20; display: flex; justify-content: space-between; align-items: center; }
        .header-logo { font-size: 14px; font-weight: 700; color: #00d4ff; }
        .header-instruction { font-size: 11px; color: rgba(255,255,255,0.7); text-align: center; flex: 1; }
        #settingsBtn { width: 40px; height: 40px; background: rgba(0,150,255,0.2); border: 1px solid rgba(0,200,255,0.3); border-radius: 10px; color: #00d4ff; font-size: 20px; cursor: pointer; }
        #demoBadge { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: #ff9900; color: #000; padding: 5px 15px; border-radius: 20px; font-size: 11px; font-weight: 600; z-index: 25; display: none; }
        #controlPanel { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10,15,25,0.95); border-top: 1px solid rgba(0,200,255,0.2); padding: 15px 20px; z-index: 25; max-height: 65vh; overflow-y: auto; transition: transform 0.3s ease; }
        #controlPanel.collapsed { transform: translateY(calc(100% - 45px)); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,200,255,0.15); }
        .panel-title { font-size: 13px; font-weight: 600; color: #00d4ff; text-transform: uppercase; letter-spacing: 1px; }
        #togglePanel { background: none; border: none; color: #00d4ff; font-size: 20px; cursor: pointer; }
        .control-section { margin-bottom: 15px; }
        .control-label { font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; }
        .shape-buttons, .pitch-buttons { display: flex; gap: 8px; }
        .shape-btn, .pitch-btn { flex: 1; padding: 10px 5px; background: rgba(0,100,200,0.15); border: 1px solid rgba(0,200,255,0.2); border-radius: 8px; color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; }
        .shape-btn.active, .pitch-btn.active { background: rgba(0,150,255,0.4); border-color: #00d4ff; color: #fff; }
        .shape-ratio { display: block; font-size: 9px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .shape-btn.active .shape-ratio { color: rgba(255,255,255,0.7); }
        .pitch-desc { display: block; font-size: 8px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .pitch-resolution { display: block; font-size: 10px; color: #00d4ff; margin-top: 4px; font-weight: 700; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .slider-value { font-size: 14px; color: #00d4ff; font-weight: 600; }
        input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: rgba(0,100,200,0.3); border-radius: 3px; outline: none; margin-bottom: 10px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: linear-gradient(135deg, #00a8ff, #00d4aa); border-radius: 50%; cursor: pointer; }
        input[type="range"]:disabled { opacity: 0.4; }
        .specs-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .spec-item { background: rgba(0,150,255,0.1); border: 1px solid rgba(0,200,255,0.15); border-radius: 8px; padding: 10px; text-align: center; }
        .spec-label { font-size: 9px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 3px; }
        .spec-value { font-size: 12px; color: #00d4ff; font-weight: 600; }
        
        /* Genre Buttons */
        .genre-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .genre-btn { flex: 1 1 auto; min-width: calc(25% - 6px); padding: 8px 6px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: rgba(255,255,255,0.6); font-size: 10px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s ease; }
        .genre-btn.active { background: #fff; border-color: #fff; color: #0a0a0f; }
        .genre-btn:hover:not(.active) { border-color: rgba(255,255,255,0.5); color: rgba(255,255,255,0.9); }
        .genre-description { font-size: 11px; color: rgba(0,200,255,0.8); text-align: center; padding: 6px 0; font-style: italic; }
        
        /* Pricing Display */
        .pricing-section { background: linear-gradient(135deg, rgba(0,200,100,0.15), rgba(0,150,255,0.1)); border: 1px solid rgba(0,255,150,0.3); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .pricing-main { text-align: center; margin-bottom: 8px; }
        .pricing-amount { font-size: 34px; font-weight: 800; color: #00ff88; letter-spacing: -1px; }
        .pricing-details { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px; }
        .pricing-details span { color: #00d4ff; font-weight: 600; }
        .pricing-viewing { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .pricing-viewing strong { color: #ffcc00; }
        
        /* Disclaimer */
        .pricing-disclaimer { font-size: 10px; color: rgba(255,255,255,0.6); line-height: 1.4; margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 2000; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(0,200,255,0.2); border-top-color: #00d4ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; font-size: 14px; color: rgba(255,255,255,0.7); }
        #placementIndicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; border: 2px dashed rgba(0,200,255,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 15; pointer-events: none; }
        #placementIndicator::before { content: '+'; font-size: 28px; color: rgba(0,200,255,0.8); }
        #placementIndicator.hidden { display: none; }
    </style>
</head>
<body>
    <div id="startScreen">
        <div class="logo-text">Prestige Visual</div>
        <div class="logo-subtitle">System</div>
        <p class="tagline">AR LED Video Wall Visualizer</p>
        <div class="features-list">
            <div class="feature-item">üìê Scale Visualization</div>
            <div class="feature-item">üé® Customization</div>
            <div class="feature-item">üìç Real-time Positioning</div>
            <div class="feature-item">üí∞ Live Pricing</div>
        </div>
        <button id="startButton">Start AR Experience</button>
        <button id="demoButton">Try Demo Mode</button>
        <span class="demo-note">Demo mode works without camera</span>
    </div>
    
    <div id="arView">
        <video id="videoFeed" autoplay playsinline muted></video>
        <div id="demoBackground"></div>
        <canvas id="threeCanvas"></canvas>
        <div id="touchLayer"></div>
        <div id="placementIndicator"></div>
        <div id="demoBadge">DEMO MODE</div>
        
        <div id="header">
            <div class="header-logo">PRESTIGE</div>
            <div class="header-instruction">Tap to place ‚Ä¢ Drag to move ‚Ä¢ Pinch to scale</div>
            <button id="settingsBtn">‚öô</button>
        </div>
        
        <div id="controlPanel">
            <div class="panel-header">
                <span class="panel-title">LED Configuration</span>
                <button id="togglePanel">‚ñº</button>
            </div>
            
            <!-- Pricing Display -->
            <div class="pricing-section">
                <div class="pricing-main">
                    <div class="pricing-amount" id="priceDisplay">$110,000+</div>
                    <div class="pricing-details">Estimated starting price ¬∑ <span id="pitchLabel">P1.9 Standard</span></div>
                </div>
                <div class="pricing-viewing">Recommended viewing: <strong id="viewingDistance">15+ feet</strong></div>
            </div>
            
            <div class="control-section">
                <label class="control-label">Screen Shape</label>
                <div class="shape-buttons">
                    <button class="shape-btn active" data-shape="rectangle">Rectangle<span class="shape-ratio">16:9</span></button>
                    <button class="shape-btn" data-shape="square">Square<span class="shape-ratio">1:1</span></button>
                    <button class="shape-btn" data-shape="ultrawide">Ultrawide<span class="shape-ratio">21:9</span></button>
                    <button class="shape-btn" data-shape="custom">Custom<span class="shape-ratio" id="customRatio">Free</span></button>
                </div>
            </div>
            <div class="control-section">
                <div class="slider-header"><label class="control-label">Width</label><span class="slider-value" id="widthValue">15.7 ft</span></div>
                <input type="range" id="widthSlider" min="0" max="18" value="6" step="1">
            </div>
            <div class="control-section">
                <div class="slider-header"><label class="control-label">Height</label><span class="slider-value" id="heightValue">8.9 ft</span></div>
                <input type="range" id="heightSlider" min="0" max="17" value="6" step="1">
            </div>
            <div class="control-section">
                <label class="control-label">Pixel Pitch</label>
                <div class="pitch-buttons">
                    <button class="pitch-btn" data-pitch="0.9">0.9mm<span class="pitch-desc">Ultra-Premium</span><span class="pitch-resolution" id="res09">5K+</span></button>
                    <button class="pitch-btn" data-pitch="1.25">1.25mm<span class="pitch-desc">Premium</span><span class="pitch-resolution" id="res125">4K</span></button>
                    <button class="pitch-btn active" data-pitch="1.9">1.9mm<span class="pitch-desc">Standard</span><span class="pitch-resolution" id="res19">2.5K</span></button>
                    <button class="pitch-btn" data-pitch="2.6">2.6mm<span class="pitch-desc">Commercial</span><span class="pitch-resolution" id="res26">2K</span></button>
                </div>
            </div>
            <div class="control-section">
                <label class="control-label">Content Preview</label>
                <div class="genre-buttons">
                    <button class="genre-btn" data-genre="worship">Worship</button>
                    <button class="genre-btn" data-genre="corporate">Corporate</button>
                    <button class="genre-btn" data-genre="sports">Sports</button>
                    <button class="genre-btn" data-genre="cinema">Cinema</button>
                    <button class="genre-btn" data-genre="concert">Concert</button>
                    <button class="genre-btn" data-genre="retail">Retail</button>
                    <button class="genre-btn active" data-genre="nature">Nature</button>
                </div>
                <div class="genre-description" id="genreDescription">Ambient & Demo Content</div>
            </div>
            <div class="control-section">
                <label class="control-label">Specifications</label>
                <div class="specs-grid">
                    <div class="spec-item"><div class="spec-label">Resolution</div><div class="spec-value" id="resolutionSpec">2566 x 1443</div></div>
                    <div class="spec-item"><div class="spec-label">Total Pixels</div><div class="spec-value" id="pixelsSpec">3.70M</div></div>
                    <div class="spec-item"><div class="spec-label">Area</div><div class="spec-value" id="areaSpec">140 sq ft</div></div>
                </div>
            </div>
            
            <!-- Disclaimer -->
            <div class="pricing-disclaimer">
                Pricing is an estimate based on selected dimensions. Actual panel configurations and final pricing confirmed during consultation.
            </div>
        </div>
    </div>
    
    <div id="loadingOverlay"><div class="spinner"></div><div class="loading-text">Initializing Camera...</div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
    (function() {
        "use strict";
        
        // ===================== GENRE DATA =====================
        var GENRES = {
            worship: { label: 'Worship', description: 'Churches & Houses of Worship' },
            corporate: { label: 'Corporate', description: 'Lobbies & Boardrooms' },
            sports: { label: 'Sports', description: 'Sports Bars & Watch Parties' },
            cinema: { label: 'Cinema', description: 'Home Theater & Media Rooms' },
            concert: { label: 'Concert', description: 'Live Events & Nightclubs' },
            retail: { label: 'Retail', description: 'Stores & Commercial Signage' },
            nature: { label: 'Nature', description: 'Ambient & Demo Content' }
        };
        
        var currentGenre = 'nature';
        
        // ===================== PANEL DIMENSIONS =====================
        var WIDTH_INCREMENTS = [
            3.9, 5.9, 7.9, 9.8, 11.8, 13.8, 15.7, 17.7, 19.7, 21.7, 
            23.6, 25.6, 27.6, 29.5, 31.5, 33.5, 35.4, 37.4, 39.4
        ];
        
        var HEIGHT_INCREMENTS = [
            2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.9, 10.0, 11.1, 12.2,
            13.3, 14.4, 15.5, 16.6, 17.7, 18.9, 20.0, 21.1
        ];
        
        // ===================== PRICING DATA =====================
        var PRICING = {
            'P0.9':  { costPerSqft: 385, minViewingFt: 7,  label: 'Ultra-Premium' },
            'P1.25': { costPerSqft: 212, minViewingFt: 10, label: 'Premium' },
            'P1.9':  { costPerSqft: 185, minViewingFt: 15, label: 'Standard' },
            'P2.6':  { costPerSqft: 140, minViewingFt: 21, label: 'Commercial' }
        };
        
        var MARGIN_DIVISOR = 0.218;
        
        function snapToIncrement(value, increments) {
            var closest = increments[0];
            var minDiff = Math.abs(value - closest);
            for (var i = 1; i < increments.length; i++) {
                var diff = Math.abs(value - increments[i]);
                if (diff < minDiff) { minDiff = diff; closest = increments[i]; }
            }
            return closest;
        }
        
        function getIncrementIndex(value, increments) {
            for (var i = 0; i < increments.length; i++) {
                if (Math.abs(increments[i] - value) < 0.1) return i;
            }
            return 0;
        }
        
        function findBestHeightForRatio(width, targetRatio) {
            return snapToIncrement(width / targetRatio, HEIGHT_INCREMENTS);
        }
        
        function findBestSquarePair(widthIndex) {
            return snapToIncrement(WIDTH_INCREMENTS[widthIndex], HEIGHT_INCREMENTS);
        }
        
        function calculateDynamicRatio(width, height) {
            var ratio = width / height;
            if (Math.abs(ratio - 16/9) < 0.15) return "~16:9";
            if (Math.abs(ratio - 21/9) < 0.15) return "~21:9";
            if (Math.abs(ratio - 4/3) < 0.15) return "~4:3";
            if (Math.abs(ratio - 1) < 0.15) return "~1:1";
            return "~" + ratio.toFixed(1) + ":1";
        }
        
        function getPitchKey(pitch) {
            if (pitch === 0.9) return 'P0.9';
            if (pitch === 1.25) return 'P1.25';
            if (pitch === 1.9) return 'P1.9';
            if (pitch === 2.6) return 'P2.6';
            return 'P1.9';
        }
        
        function getCostPerSqft(sqft, pitch) {
            var baseCost = PRICING[pitch].costPerSqft;
            if (sqft >= 175) return baseCost * 0.78;
            if (sqft >= 120) return baseCost * 0.85;
            if (sqft >= 80) return baseCost * 0.92;
            return baseCost;
        }
        
        function calculateDisplayPrice(width, height, pitch) {
            var key = getPitchKey(pitch);
            var sqft = width * height;
            var cost = getCostPerSqft(sqft, key) * sqft;
            return Math.floor((cost / MARGIN_DIVISOR) / 10000) * 10000;
        }
        
        function formatPrice(price) {
            return '$' + price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '+';
        }
        
        function updatePricing() {
            var price = calculateDisplayPrice(state.width, state.height, state.pixelPitch);
            var key = getPitchKey(state.pixelPitch);
            document.getElementById('priceDisplay').textContent = formatPrice(price);
            document.getElementById('pitchLabel').textContent = key + ' ' + PRICING[key].label;
            document.getElementById('viewingDistance').textContent = PRICING[key].minViewingFt + '+ feet';
        }
        
        // ===================== STATE =====================
        var state = {
            shape: "rectangle",
            width: 15.7,
            height: 8.9,
            pixelPitch: 1.9,
            screenPlaced: false,
            screenX: 0,
            screenY: 0,
            screenZ: -5,
            screenScale: 1,
            panelCollapsed: false
        };
        
        var scene, camera, renderer;
        var ledScreenMesh, frameMesh, glowMesh;
        var screenTexture;
        
        var contentCanvas = document.createElement("canvas");
        contentCanvas.width = 1920;
        contentCanvas.height = 1080;
        var ctx = contentCanvas.getContext("2d");
        
        var frameCount = 0;
        var touchStartX = 0, touchStartY = 0, lastPinchDist = 0;
        var isDragging = false, isPinching = false, dragStartX = 0, dragStartY = 0;
        var isMouseDown = false, mouseStartX = 0, mouseStartY = 0, mouseDragStartX = 0, mouseDragStartY = 0;
        var FT_TO_M = 0.3048;
        
        // ===================== GENRE ANIMATIONS =====================
        function drawWorship(w, h, t) {
            // Deep purple to gold gradient sky
            var bg = ctx.createLinearGradient(0, 0, 0, h);
            bg.addColorStop(0, "hsl(" + (270 + Math.sin(t*0.008)*20) + ",60%,15%)");
            bg.addColorStop(0.5, "hsl(" + (280 + Math.sin(t*0.01)*15) + ",50%,25%)");
            bg.addColorStop(1, "hsl(" + (40 + Math.sin(t*0.012)*20) + ",70%,30%)");
            ctx.fillStyle = bg; ctx.fillRect(0, 0, w, h);
            
            // Aurora rays
            for (var i = 0; i < 8; i++) {
                var rayX = w * 0.5 + Math.sin(t*0.02 + i*0.8) * w * 0.3;
                var alpha = 0.15 + Math.sin(t*0.04 + i) * 0.1;
                ctx.save(); ctx.globalAlpha = alpha;
                var rg = ctx.createLinearGradient(rayX, h, rayX + Math.sin(t*0.015+i)*100, 0);
                rg.addColorStop(0, "hsl(" + (280 + i*15) + ",80%,60%)");
                rg.addColorStop(1, "transparent");
                ctx.fillStyle = rg;
                ctx.beginPath(); ctx.moveTo(rayX - 60, h); ctx.lineTo(rayX - 20 + Math.sin(t*0.02)*30, 0);
                ctx.lineTo(rayX + 20 + Math.sin(t*0.02)*30, 0); ctx.lineTo(rayX + 60, h); ctx.fill();
                ctx.restore();
            }
            
            // Stars
            ctx.fillStyle = "rgba(255,255,255,0.8)";
            for (var s = 0; s < 50; s++) {
                var sx = (s * 137.5) % w; var sy = (s * 89.3) % (h * 0.6);
                var ss = 1 + Math.sin(t*0.1 + s) * 0.5;
                ctx.beginPath(); ctx.arc(sx, sy, ss, 0, Math.PI*2); ctx.fill();
            }
            
            // Cross silhouette
            ctx.fillStyle = "rgba(0,0,0,0.4)";
            var cx = w/2, cy = h*0.45;
            ctx.fillRect(cx - 8, cy - 80, 16, 160);
            ctx.fillRect(cx - 50, cy - 40, 100, 16);
        }
        
        function drawCorporate(w, h, t) {
            var bg = ctx.createLinearGradient(0, 0, w, h);
            bg.addColorStop(0, "#0a2540"); bg.addColorStop(0.5, "#1565c0"); bg.addColorStop(1, "#0d47a1");
            ctx.fillStyle = bg; ctx.fillRect(0, 0, w, h);
            
            ctx.strokeStyle = "rgba(100,200,255,0.15)"; ctx.lineWidth = 2;
            var gridOff = (t * 1.5) % 80;
            for (var gx = -80 + gridOff; gx < w + 80; gx += 80) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
            for (var gy = 0; gy < h; gy += 80) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
            
            ctx.fillStyle = "rgba(0,220,255,0.7)";
            for (var d = 0; d < 20; d++) {
                var dx = w/2 + Math.cos(t*0.015 + d*0.6) * w*0.4;
                var dy = h/2 + Math.sin(t*0.02 + d*0.8) * h*0.35;
                ctx.beginPath(); ctx.arc(dx, dy, 6 + Math.sin(t*0.05 + d)*3, 0, Math.PI*2); ctx.fill();
            }
            
            for (var b = 0; b < 8; b++) {
                var bh = 80 + Math.abs(Math.sin(t*0.03 + b*0.6)) * 150;
                var bx = w*0.1 + b * (w*0.1);
                var bgr = ctx.createLinearGradient(0, h*0.85 - bh, 0, h*0.85);
                bgr.addColorStop(0, "#00e5ff"); bgr.addColorStop(1, "#0066cc");
                ctx.fillStyle = bgr; ctx.fillRect(bx, h*0.85 - bh, w*0.08, bh);
            }
            
            ctx.fillStyle = "#ffffff"; ctx.font = "bold " + Math.round(w*0.05) + "px Arial";
            ctx.textAlign = "center"; ctx.fillText("PRESTIGE CORP", w/2, h*0.12);
            ctx.fillStyle = "rgba(200,240,255,0.9)"; ctx.font = Math.round(w*0.025) + "px Arial";
            ctx.fillText("Q4 Performance Dashboard", w/2, h*0.18);
            
            ctx.fillStyle = "rgba(0,0,0,0.75)"; ctx.fillRect(0, h*0.9, w, h*0.1);
            ctx.fillStyle = "#00ff88"; ctx.font = Math.round(w*0.02) + "px monospace"; ctx.textAlign = "left";
            var ticker = "    STOCK: +2.4%    |    REVENUE: $4.2B    |    GROWTH: 18%    ";
            ctx.fillText(ticker + ticker, w - ((t * 2.5) % (w * 1.5)), h*0.96);
        }
        
        function drawSports(w, h, t) {
            var fg = ctx.createLinearGradient(0, 0, 0, h);
            fg.addColorStop(0, "#1b5e20"); fg.addColorStop(0.5, "#43a047"); fg.addColorStop(1, "#1b5e20");
            ctx.fillStyle = fg; ctx.fillRect(0, 0, w, h);
            
            for (var s = 0; s < 10; s++) {
                ctx.fillStyle = s % 2 === 0 ? "rgba(0,50,0,0.25)" : "rgba(50,100,50,0.15)";
                ctx.fillRect(0, s * h/10, w, h/10);
            }
            
            ctx.strokeStyle = "rgba(255,255,255,0.9)"; ctx.lineWidth = 4;
            ctx.strokeRect(w*0.05, h*0.05, w*0.9, h*0.9);
            ctx.beginPath(); ctx.moveTo(w/2, h*0.05); ctx.lineTo(w/2, h*0.95); ctx.stroke();
            ctx.beginPath(); ctx.arc(w/2, h/2, w*0.08, 0, Math.PI*2); ctx.stroke();
            
            var ballX = w*0.4 + Math.sin(t*0.04) * w*0.15;
            var ballY = h*0.5 + Math.cos(t*0.05) * h*0.2;
            ctx.save(); ctx.translate(ballX, ballY); ctx.rotate(t * 0.08);
            ctx.beginPath(); ctx.arc(0, 0, w*0.025, 0, Math.PI*2);
            ctx.fillStyle = "#fff"; ctx.fill();
            ctx.strokeStyle = "#333"; ctx.lineWidth = 3; ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-w*0.015, 0); ctx.lineTo(w*0.015, 0);
            ctx.moveTo(0, -w*0.015); ctx.lineTo(0, w*0.015); ctx.stroke();
            ctx.restore();
            
            ctx.fillStyle = "rgba(0,0,0,0.92)"; ctx.fillRect(w*0.28, h*0.02, w*0.44, h*0.15);
            ctx.strokeStyle = "#ffc107"; ctx.lineWidth = 4; ctx.strokeRect(w*0.28, h*0.02, w*0.44, h*0.15);
            ctx.fillStyle = "#fff"; ctx.font = "bold " + Math.round(w*0.025) + "px Arial"; ctx.textAlign = "center";
            ctx.fillText("HOME", w*0.38, h*0.07); ctx.fillText("AWAY", w*0.62, h*0.07);
            var hs = 2 + Math.floor((t/350) % 3); var as = 1 + Math.floor((t/450) % 2);
            ctx.fillStyle = "#00ff00"; ctx.font = "bold " + Math.round(w*0.045) + "px monospace";
            ctx.fillText(hs + " - " + as, w/2, h*0.135);
        }
        
        function drawCinema(w, h, t) {
            // Letterbox cinema look
            ctx.fillStyle = "#000"; ctx.fillRect(0, 0, w, h);
            
            var letterboxH = h * 0.12;
            var viewH = h - letterboxH * 2;
            
            // Cinematic landscape
            var sky = ctx.createLinearGradient(0, letterboxH, 0, letterboxH + viewH * 0.6);
            sky.addColorStop(0, "hsl(" + (220 + Math.sin(t*0.005)*20) + ",60%,20%)");
            sky.addColorStop(1, "hsl(" + (30 + Math.sin(t*0.008)*15) + ",80%,40%)");
            ctx.fillStyle = sky; ctx.fillRect(0, letterboxH, w, viewH * 0.6);
            
            // Sun/moon
            var sunY = letterboxH + viewH * 0.25 + Math.sin(t*0.01) * 20;
            var sunGlow = ctx.createRadialGradient(w*0.7, sunY, 0, w*0.7, sunY, w*0.15);
            sunGlow.addColorStop(0, "rgba(255,200,100,1)");
            sunGlow.addColorStop(0.3, "rgba(255,150,50,0.6)");
            sunGlow.addColorStop(1, "transparent");
            ctx.fillStyle = sunGlow; ctx.fillRect(0, letterboxH, w, viewH);
            
            // Mountains
            ctx.fillStyle = "hsl(220,30%,15%)";
            ctx.beginPath(); ctx.moveTo(0, letterboxH + viewH * 0.6);
            for (var mx = 0; mx <= w; mx += w * 0.1) {
                var my = letterboxH + viewH * 0.4 + Math.sin(mx * 0.01 + 1) * viewH * 0.15;
                ctx.lineTo(mx, my);
            }
            ctx.lineTo(w, letterboxH + viewH); ctx.lineTo(0, letterboxH + viewH); ctx.fill();
            
            // Water reflection
            ctx.fillStyle = "hsl(220,40%,12%)";
            ctx.fillRect(0, letterboxH + viewH * 0.7, w, viewH * 0.3);
            
            // Letterbox bars
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, w, letterboxH);
            ctx.fillRect(0, h - letterboxH, w, letterboxH);
        }
        
        function drawConcert(w, h, t) {
            ctx.fillStyle = "#08000f"; ctx.fillRect(0, 0, w, h);
            
            var colors = ["#ff00ff","#00ffff","#ffff00","#ff0088","#00ff88","#8800ff","#ff8800"];
            for (var i = 0; i < 12; i++) {
                var ang = Math.sin(t*0.025 + i*0.45) * 0.55;
                var alpha = 0.22 + Math.sin(t*0.07 + i*0.6) * 0.12;
                ctx.save(); ctx.globalAlpha = alpha;
                var topX = w/2 + Math.tan(ang) * h;
                ctx.beginPath(); ctx.moveTo(w/2, h);
                ctx.lineTo(topX - w*0.08, 0); ctx.lineTo(topX + w*0.08, 0); ctx.closePath();
                var lg = ctx.createLinearGradient(w/2, h, topX, 0);
                lg.addColorStop(0, colors[i % colors.length]);
                lg.addColorStop(0.8, colors[i % colors.length]);
                lg.addColorStop(1, "transparent");
                ctx.fillStyle = lg; ctx.fill(); ctx.restore();
            }
            
            if (Math.sin(t*0.25) > 0.94) {
                ctx.fillStyle = "rgba(255,255,255,0.18)"; ctx.fillRect(0, 0, w, h);
            }
            
            ctx.fillStyle = "#000"; ctx.beginPath(); ctx.moveTo(0, h);
            for (var cx = 0; cx <= w; cx += w*0.015) {
                ctx.lineTo(cx, h - (h*0.08 + Math.sin(t*0.12 + cx*0.006) * h*0.04));
            }
            ctx.lineTo(w, h); ctx.fill();
            
            ctx.shadowColor = "#ff00ff"; ctx.shadowBlur = 35 + Math.sin(t*0.04) * 15;
            ctx.fillStyle = "#fff"; ctx.font = "bold " + Math.round(w*0.08) + "px Arial";
            ctx.textAlign = "center"; ctx.fillText("LIVE", w/2, h*0.32);
            ctx.shadowBlur = 0;
            
            for (var e = 0; e < 22; e++) {
                var eh = h*0.04 + Math.abs(Math.sin(t*0.18 + e*0.35)) * h*0.12;
                ctx.fillStyle = "hsl(" + ((e*16 + t*1.8) % 360) + ",100%,55%)";
                ctx.fillRect(w*0.08 + e*(w*0.038), h*0.52 - eh/2, w*0.03, eh);
            }
        }
        
        function drawRetail(w, h, t) {
            var hue = (t * 1.8) % 360;
            var rg = ctx.createLinearGradient(0, 0, w, h);
            rg.addColorStop(0, "hsl(" + hue + ",75%,50%)");
            rg.addColorStop(0.5, "hsl(" + ((hue+50)%360) + ",70%,45%)");
            rg.addColorStop(1, "hsl(" + ((hue+100)%360) + ",75%,40%)");
            ctx.fillStyle = rg; ctx.fillRect(0, 0, w, h);
            
            ctx.fillStyle = "rgba(255,255,255,0.85)";
            for (var sp = 0; sp < 35; sp++) {
                var spx = (Math.sin(t*0.018 + sp*0.65) * 0.42 + 0.5) * w;
                var spy = ((sp * 0.085 + t*0.004) % 1.15) * h;
                ctx.beginPath(); ctx.arc(spx, spy, 4 + Math.sin(t*0.08 + sp) * 3, 0, Math.PI*2); ctx.fill();
            }
            
            ctx.save(); ctx.translate(w/2, h/2);
            ctx.scale(1 + Math.sin(t*0.08) * 0.04, 1 + Math.sin(t*0.08) * 0.04);
            ctx.rotate(Math.sin(t*0.018) * 0.04);
            ctx.fillStyle = "#d32f2f"; ctx.beginPath();
            ctx.moveTo(-w*0.35, -h*0.1); ctx.lineTo(w*0.35, -h*0.1);
            ctx.lineTo(w*0.38, 0); ctx.lineTo(w*0.35, h*0.1);
            ctx.lineTo(-w*0.35, h*0.1); ctx.lineTo(-w*0.38, 0); ctx.closePath(); ctx.fill();
            ctx.fillStyle = "rgba(255,255,255," + (Math.sin(t*0.12) > 0.25 ? 1 : 0.82) + ")";
            ctx.font = "bold " + Math.round(w*0.1) + "px Arial"; ctx.textAlign = "center";
            ctx.textBaseline = "middle"; ctx.fillText("SALE", 0, 0);
            ctx.restore();
            
            ctx.fillStyle = "#fff"; ctx.font = "bold " + Math.round(w*0.045) + "px Arial";
            ctx.textAlign = "center"; ctx.textBaseline = "alphabetic";
            ctx.fillText("UP TO " + (30 + Math.floor((Math.sin(t*0.012) + 1) * 12)) + "% OFF!", w/2, h*0.8);
            
            ctx.fillStyle = "rgba(0,0,0,0.78)"; ctx.fillRect(0, h*0.88, w, h*0.12);
            ctx.fillStyle = "#ffeb3b"; ctx.font = "bold " + Math.round(w*0.028) + "px Arial"; ctx.textAlign = "left";
            var tMsg = "‚òÖ LIMITED TIME ‚òÖ FREE SHIPPING ‚òÖ SHOP NOW ‚òÖ BEST DEALS ‚òÖ ";
            ctx.fillText(tMsg + tMsg, w - ((t * 3.5) % (w * 1.8)), h*0.95);
        }
        
        function drawNature(w, h, t) {
            // Aurora borealis / mountain scene
            var sky = ctx.createLinearGradient(0, 0, 0, h * 0.7);
            sky.addColorStop(0, "#0a0a20");
            sky.addColorStop(0.5, "hsl(" + (200 + Math.sin(t*0.01)*30) + ",50%,15%)");
            sky.addColorStop(1, "hsl(" + (180 + Math.sin(t*0.008)*20) + ",40%,20%)");
            ctx.fillStyle = sky; ctx.fillRect(0, 0, w, h);
            
            // Aurora waves
            for (var a = 0; a < 5; a++) {
                ctx.save();
                ctx.globalAlpha = 0.3 + Math.sin(t*0.03 + a) * 0.15;
                var ag = ctx.createLinearGradient(0, h*0.1, 0, h*0.5);
                ag.addColorStop(0, "transparent");
                ag.addColorStop(0.3, "hsl(" + (120 + a*20 + Math.sin(t*0.02)*30) + ",80%,50%)");
                ag.addColorStop(0.7, "hsl(" + (180 + a*15 + Math.sin(t*0.025)*20) + ",70%,40%)");
                ag.addColorStop(1, "transparent");
                ctx.fillStyle = ag;
                ctx.beginPath(); ctx.moveTo(0, h*0.1);
                for (var ax = 0; ax <= w; ax += 20) {
                    var ay = h*0.25 + Math.sin(ax*0.008 + t*0.03 + a*0.5) * h*0.1;
                    ctx.lineTo(ax, ay);
                }
                ctx.lineTo(w, h*0.5); ctx.lineTo(0, h*0.5); ctx.fill();
                ctx.restore();
            }
            
            // Stars
            ctx.fillStyle = "#fff";
            for (var st = 0; st < 100; st++) {
                var stx = (st * 193.7) % w; var sty = (st * 71.3) % (h * 0.5);
                var sts = 0.5 + Math.sin(t*0.1 + st*0.5) * 0.5;
                ctx.globalAlpha = 0.5 + Math.sin(t*0.15 + st) * 0.3;
                ctx.beginPath(); ctx.arc(stx, sty, sts, 0, Math.PI*2); ctx.fill();
            }
            ctx.globalAlpha = 1;
            
            // Mountains
            ctx.fillStyle = "#1a1a2e";
            ctx.beginPath(); ctx.moveTo(0, h);
            ctx.lineTo(0, h*0.7); ctx.lineTo(w*0.15, h*0.5); ctx.lineTo(w*0.3, h*0.65);
            ctx.lineTo(w*0.5, h*0.4); ctx.lineTo(w*0.7, h*0.6); ctx.lineTo(w*0.85, h*0.45);
            ctx.lineTo(w, h*0.55); ctx.lineTo(w, h); ctx.fill();
            
            // Snow caps
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.beginPath(); ctx.moveTo(w*0.5, h*0.4); ctx.lineTo(w*0.45, h*0.48); ctx.lineTo(w*0.55, h*0.48); ctx.fill();
            ctx.beginPath(); ctx.moveTo(w*0.85, h*0.45); ctx.lineTo(w*0.8, h*0.52); ctx.lineTo(w*0.9, h*0.52); ctx.fill();
            
            // Lake reflection
            ctx.fillStyle = "rgba(20,40,60,0.8)";
            ctx.fillRect(0, h*0.85, w, h*0.15);
        }
        
        function renderContent() {
            var w = contentCanvas.width, h = contentCanvas.height;
            ctx.clearRect(0, 0, w, h);
            
            switch (currentGenre) {
                case 'worship': drawWorship(w, h, frameCount); break;
                case 'corporate': drawCorporate(w, h, frameCount); break;
                case 'sports': drawSports(w, h, frameCount); break;
                case 'cinema': drawCinema(w, h, frameCount); break;
                case 'concert': drawConcert(w, h, frameCount); break;
                case 'retail': drawRetail(w, h, frameCount); break;
                default: drawNature(w, h, frameCount);
            }
            
            frameCount++;
            if (screenTexture) screenTexture.needsUpdate = true;
        }
        
        function calcResolution(pitch) {
            var wMM = state.width * 304.8, hMM = state.height * 304.8;
            return { w: Math.round(wMM / pitch), h: Math.round(hMM / pitch) };
        }
        
        function getResolutionLabel(px) {
            if (px >= 7680) return "8K"; if (px >= 5120) return "5K";
            if (px >= 4000) return "4K+"; if (px >= 3840) return "4K";
            if (px >= 3000) return "3K+"; if (px >= 2560) return "2.5K";
            if (px >= 2000) return "2K+"; if (px >= 1920) return "2K";
            if (px >= 1280) return "HD+"; return "HD";
        }
        
        function updatePitchResolutions() {
            var pitches = [0.9, 1.25, 1.9, 2.6];
            var ids = ["res09", "res125", "res19", "res26"];
            for (var i = 0; i < pitches.length; i++) {
                var r = calcResolution(pitches[i]);
                document.getElementById(ids[i]).textContent = getResolutionLabel(r.w);
            }
        }
        
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("threeCanvas"), alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x000000, 0);
            window.addEventListener("resize", function() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        function createScreen() {
            if (ledScreenMesh) { scene.remove(ledScreenMesh); ledScreenMesh.geometry.dispose(); ledScreenMesh.material.dispose(); }
            if (frameMesh) { scene.remove(frameMesh); frameMesh.geometry.dispose(); frameMesh.material.dispose(); }
            if (glowMesh) { scene.remove(glowMesh); glowMesh.geometry.dispose(); glowMesh.material.dispose(); }
            
            var wm = state.width * FT_TO_M, hm = state.height * FT_TO_M;
            
            screenTexture = new THREE.CanvasTexture(contentCanvas);
            screenTexture.minFilter = THREE.LinearFilter;
            screenTexture.magFilter = THREE.LinearFilter;
            
            var glowGeo = new THREE.PlaneGeometry(wm + 0.5, hm + 0.5);
            var glowMat = new THREE.MeshBasicMaterial({ color: 0x00aaff, transparent: true, opacity: 0.25, side: THREE.DoubleSide });
            glowMesh = new THREE.Mesh(glowGeo, glowMat);
            glowMesh.position.set(state.screenX, state.screenY, state.screenZ - 0.03);
            glowMesh.scale.setScalar(state.screenScale);
            scene.add(glowMesh);
            
            var frameGeo = new THREE.PlaneGeometry(wm + 0.12, hm + 0.12);
            var frameMat = new THREE.MeshBasicMaterial({ color: 0x111111, side: THREE.DoubleSide });
            frameMesh = new THREE.Mesh(frameGeo, frameMat);
            frameMesh.position.set(state.screenX, state.screenY, state.screenZ - 0.015);
            frameMesh.scale.setScalar(state.screenScale);
            scene.add(frameMesh);
            
            var screenGeo = new THREE.PlaneGeometry(wm, hm);
            var screenMat = new THREE.MeshBasicMaterial({ map: screenTexture, side: THREE.FrontSide });
            ledScreenMesh = new THREE.Mesh(screenGeo, screenMat);
            ledScreenMesh.position.set(state.screenX, state.screenY, state.screenZ);
            ledScreenMesh.scale.setScalar(state.screenScale);
            scene.add(ledScreenMesh);
        }
        
        function updateDimensions() {
            if (!ledScreenMesh) return;
            var wm = state.width * FT_TO_M, hm = state.height * FT_TO_M;
            ledScreenMesh.geometry.dispose(); ledScreenMesh.geometry = new THREE.PlaneGeometry(wm, hm);
            frameMesh.geometry.dispose(); frameMesh.geometry = new THREE.PlaneGeometry(wm + 0.12, hm + 0.12);
            glowMesh.geometry.dispose(); glowMesh.geometry = new THREE.PlaneGeometry(wm + 0.5, hm + 0.5);
            updateSpecs(); updatePitchResolutions(); updatePricing();
        }
        
        function updatePositions() {
            if (ledScreenMesh) { ledScreenMesh.position.x = state.screenX; ledScreenMesh.position.y = state.screenY; }
            if (frameMesh) { frameMesh.position.x = state.screenX; frameMesh.position.y = state.screenY; }
            if (glowMesh) { glowMesh.position.x = state.screenX; glowMesh.position.y = state.screenY; }
        }
        
        function updateScales() {
            if (ledScreenMesh) ledScreenMesh.scale.setScalar(state.screenScale);
            if (frameMesh) frameMesh.scale.setScalar(state.screenScale);
            if (glowMesh) glowMesh.scale.setScalar(state.screenScale);
        }
        
        function updateSpecs() {
            var res = calcResolution(state.pixelPitch);
            var total = res.w * res.h;
            var sqft = Math.round(state.width * state.height);
            document.getElementById("resolutionSpec").textContent = res.w + " x " + res.h;
            document.getElementById("pixelsSpec").textContent = total >= 1000000 ? (total / 1000000).toFixed(2) + "M" : Math.round(total / 1000) + "K";
            document.getElementById("areaSpec").textContent = sqft + " sq ft";
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderContent();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }
        
        function startCamera(cb) {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
                    .then(function(stream) {
                        document.getElementById("videoFeed").srcObject = stream;
                        document.getElementById("videoFeed").play().then(function() { cb(true); }).catch(function() { cb(true); });
                    }).catch(function() { cb(false); });
            } else { cb(false); }
        }
        
        function startAR(demo) {
            document.getElementById("startScreen").style.display = "none";
            document.getElementById("arView").style.display = "block";
            
            if (demo) {
                document.getElementById("videoFeed").style.display = "none";
                document.getElementById("demoBackground").style.display = "block";
                document.getElementById("demoBadge").style.display = "block";
                initThree(); setupControls(); animate();
            } else {
                document.getElementById("loadingOverlay").style.display = "flex";
                startCamera(function(ok) {
                    document.getElementById("loadingOverlay").style.display = "none";
                    if (ok) {
                        document.getElementById("videoFeed").style.display = "block";
                        document.getElementById("demoBackground").style.display = "none";
                        initThree(); setupControls(); animate();
                    } else {
                        if (confirm("Camera unavailable. Try Demo Mode?")) startAR(true);
                    }
                });
            }
        }
        
        function setupControls() {
            var shapeButtons = document.querySelectorAll(".shape-btn");
            var pitchButtons = document.querySelectorAll(".pitch-btn");
            var genreButtons = document.querySelectorAll(".genre-btn");
            var widthSlider = document.getElementById("widthSlider");
            var heightSlider = document.getElementById("heightSlider");
            var widthValue = document.getElementById("widthValue");
            var heightValue = document.getElementById("heightValue");
            var customRatioEl = document.getElementById("customRatio");
            var togglePanel = document.getElementById("togglePanel");
            var settingsBtn = document.getElementById("settingsBtn");
            var controlPanel = document.getElementById("controlPanel");
            
            widthSlider.min = 0; widthSlider.max = WIDTH_INCREMENTS.length - 1;
            heightSlider.min = 0; heightSlider.max = HEIGHT_INCREMENTS.length - 1;
            widthSlider.value = getIncrementIndex(state.width, WIDTH_INCREMENTS);
            heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
            
            updatePitchResolutions(); updatePricing(); updateSliderDisplays();
            
            function setActive(btns, btn) {
                for (var i = 0; i < btns.length; i++) btns[i].classList.remove("active");
                btn.classList.add("active");
            }
            
            function updateSliderDisplays() {
                widthValue.textContent = state.width + " ft";
                heightValue.textContent = state.height + " ft";
                if (state.shape === "custom") customRatioEl.textContent = calculateDynamicRatio(state.width, state.height);
            }
            
            function applyShapeConstraints() {
                var widthIdx = parseInt(widthSlider.value);
                var newWidth = WIDTH_INCREMENTS[widthIdx];
                var newHeight;
                
                if (state.shape === "rectangle") {
                    newHeight = findBestHeightForRatio(newWidth, 16/9);
                    heightSlider.disabled = true;
                } else if (state.shape === "square") {
                    newHeight = findBestSquarePair(widthIdx);
                    heightSlider.disabled = true;
                } else if (state.shape === "ultrawide") {
                    newHeight = findBestHeightForRatio(newWidth, 21/9);
                    heightSlider.disabled = true;
                } else {
                    newHeight = HEIGHT_INCREMENTS[parseInt(heightSlider.value)];
                    heightSlider.disabled = false;
                }
                
                state.width = newWidth; state.height = newHeight;
                heightSlider.value = getIncrementIndex(newHeight, HEIGHT_INCREMENTS);
                updateSliderDisplays(); updateDimensions();
            }
            
            for (var i = 0; i < shapeButtons.length; i++) {
                shapeButtons[i].addEventListener("click", function() {
                    setActive(shapeButtons, this);
                    state.shape = this.getAttribute("data-shape");
                    if (state.shape !== "custom") customRatioEl.textContent = "Free";
                    applyShapeConstraints();
                });
            }
            
            for (var j = 0; j < pitchButtons.length; j++) {
                pitchButtons[j].addEventListener("click", function() {
                    setActive(pitchButtons, this);
                    state.pixelPitch = parseFloat(this.getAttribute("data-pitch"));
                    updateSpecs(); updatePricing();
                });
            }
            
            for (var k = 0; k < genreButtons.length; k++) {
                genreButtons[k].addEventListener("click", function() {
                    setActive(genreButtons, this);
                    currentGenre = this.getAttribute("data-genre");
                    document.getElementById("genreDescription").textContent = GENRES[currentGenre].description;
                });
            }
            
            widthSlider.addEventListener("input", applyShapeConstraints);
            heightSlider.addEventListener("input", function() {
                if (state.shape === "custom") {
                    state.height = HEIGHT_INCREMENTS[parseInt(this.value)];
                    updateSliderDisplays(); updateDimensions();
                }
            });
            
            function togglePanelFn() {
                state.panelCollapsed = !state.panelCollapsed;
                controlPanel.classList.toggle("collapsed", state.panelCollapsed);
                togglePanel.textContent = state.panelCollapsed ? "‚ñ≤" : "‚ñº";
            }
            togglePanel.addEventListener("click", togglePanelFn);
            settingsBtn.addEventListener("click", togglePanelFn);
            
            var touchLayer = document.getElementById("touchLayer");
            var placementIndicator = document.getElementById("placementIndicator");
            
            touchLayer.addEventListener("touchstart", function(e) {
                e.preventDefault();
                var t = e.touches;
                if (t.length === 1) {
                    if (!state.screenPlaced) {
                        state.screenPlaced = true;
                        placementIndicator.classList.add("hidden");
                        createScreen();
                    } else {
                        isDragging = true;
                        touchStartX = t[0].clientX; touchStartY = t[0].clientY;
                        dragStartX = state.screenX; dragStartY = state.screenY;
                    }
                } else if (t.length === 2 && state.screenPlaced) {
                    isDragging = false; isPinching = true;
                    var dx = t[0].clientX - t[1].clientX, dy = t[0].clientY - t[1].clientY;
                    lastPinchDist = Math.sqrt(dx*dx + dy*dy);
                }
            }, { passive: false });
            
            touchLayer.addEventListener("touchmove", function(e) {
                e.preventDefault();
                var t = e.touches;
                if (isDragging && t.length === 1 && state.screenPlaced) {
                    var dx = (t[0].clientX - touchStartX) / window.innerWidth * 10;
                    var dy = -(t[0].clientY - touchStartY) / window.innerHeight * 8;
                    state.screenX = Math.max(-10, Math.min(10, dragStartX + dx));
                    state.screenY = Math.max(-6, Math.min(6, dragStartY + dy));
                    updatePositions();
                } else if (isPinching && t.length === 2 && state.screenPlaced) {
                    var pdx = t[0].clientX - t[1].clientX, pdy = t[0].clientY - t[1].clientY;
                    var dist = Math.sqrt(pdx*pdx + pdy*pdy);
                    if (lastPinchDist > 0) {
                        state.screenScale = Math.max(0.3, Math.min(5, state.screenScale * (dist / lastPinchDist)));
                        updateScales();
                    }
                    lastPinchDist = dist;
                }
            }, { passive: false });
            
            touchLayer.addEventListener("touchend", function(e) {
                e.preventDefault();
                isDragging = false;
                if (e.touches.length < 2) { isPinching = false; lastPinchDist = 0; }
            }, { passive: false });
            
            touchLayer.addEventListener("mousedown", function(e) {
                e.preventDefault();
                if (!state.screenPlaced) {
                    state.screenPlaced = true;
                    placementIndicator.classList.add("hidden");
                    createScreen();
                } else {
                    isMouseDown = true;
                    mouseStartX = e.clientX; mouseStartY = e.clientY;
                    mouseDragStartX = state.screenX; mouseDragStartY = state.screenY;
                }
            });
            
            touchLayer.addEventListener("mousemove", function(e) {
                if (!isMouseDown || !state.screenPlaced) return;
                var dx = (e.clientX - mouseStartX) / window.innerWidth * 10;
                var dy = -(e.clientY - mouseStartY) / window.innerHeight * 8;
                state.screenX = Math.max(-10, Math.min(10, mouseDragStartX + dx));
                state.screenY = Math.max(-6, Math.min(6, mouseDragStartY + dy));
                updatePositions();
            });
            
            touchLayer.addEventListener("mouseup", function() { isMouseDown = false; });
            
            touchLayer.addEventListener("wheel", function(e) {
                e.preventDefault();
                if (state.screenPlaced) {
                    state.screenScale = Math.max(0.3, Math.min(5, state.screenScale * (e.deltaY > 0 ? 0.95 : 1.05)));
                    updateScales();
                }
            }, { passive: false });
            
            applyShapeConstraints();
            updateSpecs();
        }
        
        document.getElementById("startButton").addEventListener("click", function() { startAR(false); });
        document.getElementById("demoButton").addEventListener("click", function() { startAR(true); });
    })();
    </script>
</body>
</html>
