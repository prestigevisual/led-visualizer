<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Prestige Visual System - AR LED Video Wall Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0a0a1a 0%, #0f1a2a 50%, #0a0a0f 100%); color: #fff; -webkit-user-select: none; user-select: none; }
        
        .container { min-height: 100%; padding: 20px; padding-bottom: 100px; }
        
        .header { text-align: center; padding: 30px 0; }
        .logo-text { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #00a8ff, #00ffcc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo-subtitle { font-size: 12px; color: rgba(0,200,255,0.7); text-transform: uppercase; letter-spacing: 6px; margin-top: 5px; }
        
        .preview-section { background: rgba(0,0,0,0.4); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,200,255,0.2); }
        .preview-wrapper { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .preview-cabinet { background: #0a0a0a; padding: 6px; border-radius: 2px; box-shadow: 0 8px 32px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.05); }
        .preview-screen { position: relative; overflow: hidden; background: #000; }
        #previewCanvas { display: block; }
        .preview-label { text-align: center; font-size: 12px; color: rgba(255,255,255,0.5); }
        
        .ar-button { display: flex; width: 100%; padding: 18px; font-size: 18px; font-weight: 700; color: #000; background: linear-gradient(135deg, #00ff88, #00d4ff); border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .ar-button:active { transform: scale(0.98); }
        .ar-button.loading { background: linear-gradient(135deg, #666, #444); pointer-events: none; }
        .ar-button svg { width: 24px; height: 24px; }
        
        .ar-note { text-align: center; font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 20px; }
        #arDimensions { color: #00d4ff; font-weight: 600; }
        
        .config-section { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(0,200,255,0.15); }
        .section-title { font-size: 11px; color: #00d4ff; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; font-weight: 600; }
        
        .pricing-display { text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(0,200,100,0.15), rgba(0,150,255,0.1)); border-radius: 12px; border: 1px solid rgba(0,255,150,0.3); margin-bottom: 15px; }
        .price { font-size: 42px; font-weight: 800; color: #00ff88; }
        .price-details { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 5px; }
        .price-details span { color: #00d4ff; font-weight: 600; }
        .viewing-distance { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .viewing-distance strong { color: #ffcc00; }
        
        .button-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .option-btn { padding: 12px 8px; background: rgba(0,100,200,0.15); border: 1px solid rgba(0,200,255,0.2); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
        .option-btn.active { background: rgba(0,150,255,0.4); border-color: #00d4ff; color: #fff; }
        .option-btn small { display: block; font-size: 9px; color: rgba(255,255,255,0.4); margin-top: 3px; font-weight: 400; }
        .option-btn.active small { color: rgba(255,255,255,0.7); }
        
        .slider-group { margin-bottom: 15px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .slider-label { font-size: 12px; color: rgba(255,255,255,0.6); }
        .slider-value { font-size: 16px; color: #00d4ff; font-weight: 700; }
        input[type="range"] { width: 100%; height: 8px; -webkit-appearance: none; background: rgba(0,100,200,0.3); border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: linear-gradient(135deg, #00a8ff, #00d4aa); border-radius: 50%; cursor: pointer; }
        input[type="range"]:disabled { opacity: 0.4; }
        
        .genre-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px; }
        .genre-btn { padding: 10px 6px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .genre-btn.active { background: #fff; border-color: #fff; color: #0a0a0f; }
        .genre-description { text-align: center; font-size: 11px; color: rgba(0,200,255,0.8); font-style: italic; padding: 5px 0; }
        
        .specs-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .spec-box { background: rgba(0,150,255,0.1); border: 1px solid rgba(0,200,255,0.15); border-radius: 10px; padding: 12px; text-align: center; }
        .spec-label { font-size: 9px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 4px; }
        .spec-value { font-size: 14px; color: #00d4ff; font-weight: 600; }
        
        .disclaimer { font-size: 10px; color: rgba(255,255,255,0.4); text-align: center; line-height: 1.5; padding: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-text">Prestige Visual</div>
            <div class="logo-subtitle">System</div>
        </div>
        
        <div class="preview-section">
            <div class="preview-wrapper">
                <div class="preview-cabinet">
                    <div class="preview-screen">
                        <canvas id="previewCanvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="preview-label">LED pixel simulation · <span id="pitchPreview">P1.9</span></div>
        </div>
        
        <a id="arLink" rel="ar" href="#" class="ar-button">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4v6h2V6h4V4H3zm18 0h-6v2h4v4h2V4zm-2 14h-4v2h6v-6h-2v4zM5 18v-4H3v6h6v-2H5zm7-12L5.5 9.5 12 13l6.5-3.5L12 6zm0 8.5l-5.5-3v3L12 18l5.5-3.5v-3L12 14.5z"/></svg>
            <span id="arButtonText">View in Your Space</span>
        </a>
        
        <div class="ar-note">Opens iOS AR viewer · Size: <span id="arDimensions">13.8 ft × 7.7 ft</span></div>
        
        <div class="config-section">
            <div class="section-title">Pricing</div>
            <div class="pricing-display">
                <div class="price" id="priceDisplay">$80,000+</div>
                <div class="price-details">Estimated starting price · <span id="pitchLabel">P1.9 Standard</span></div>
                <div class="viewing-distance">Recommended viewing: <strong id="viewingDistance">15+ feet</strong></div>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Screen Shape</div>
            <div class="button-grid">
                <button class="option-btn active" data-shape="rectangle">Rectangle<small>16:9</small></button>
                <button class="option-btn" data-shape="square">Square<small>1:1</small></button>
                <button class="option-btn" data-shape="ultrawide">Ultrawide<small>21:9</small></button>
                <button class="option-btn" data-shape="custom">Custom<small>Free</small></button>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Dimensions</div>
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Width</span>
                    <span class="slider-value" id="widthValue">13.8 ft</span>
                </div>
                <input type="range" id="widthSlider" min="0" max="18" value="5" step="1">
            </div>
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Height</span>
                    <span class="slider-value" id="heightValue">7.7 ft</span>
                </div>
                <input type="range" id="heightSlider" min="0" max="17" value="5" step="1">
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Pixel Pitch</div>
            <div class="button-grid">
                <button class="option-btn" data-pitch="0.9">P0.9<small>Ultra HD</small></button>
                <button class="option-btn" data-pitch="1.25">P1.25<small>Premium</small></button>
                <button class="option-btn active" data-pitch="1.9">P1.9<small>Standard</small></button>
                <button class="option-btn" data-pitch="2.6">P2.6<small>Value</small></button>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Content Preview</div>
            <div class="genre-grid">
                <button class="genre-btn" data-genre="worship">Worship</button>
                <button class="genre-btn" data-genre="corporate">Corporate</button>
                <button class="genre-btn active" data-genre="sports">Sports</button>
                <button class="genre-btn" data-genre="concert">Concert</button>
            </div>
            <div class="genre-description" id="genreDescription">Sports Bars & Game Day</div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Specifications</div>
            <div class="specs-row">
                <div class="spec-box"><div class="spec-label">Resolution</div><div class="spec-value" id="resolutionSpec">2212 x 1244</div></div>
                <div class="spec-box"><div class="spec-label">Total Pixels</div><div class="spec-value" id="pixelsSpec">2.75M</div></div>
                <div class="spec-box"><div class="spec-label">Area</div><div class="spec-value" id="areaSpec">106 sq ft</div></div>
            </div>
        </div>
        
        <div class="disclaimer">
            Pricing is an estimate based on selected dimensions. Final pricing confirmed during consultation.
        </div>
    </div>
    
    <canvas id="textureCanvas" style="display:none;"></canvas>

    <script>
        var IMAGE_PATHS = {
            sports: 'images/sports.jpg',
            worship: 'images/worship.jpg',
            corporate: 'images/corporate.jpg',
            concert: 'images/concert.jpg'
        };
        
        var GENRES = {
            worship: { description: 'Churches & Houses of Worship' },
            corporate: { description: 'Lobbies & Boardrooms' },
            sports: { description: 'Sports Bars & Game Day' },
            concert: { description: 'Live Events & Nightclubs' }
        };
        
        var WIDTH_INCREMENTS = [3.9, 5.9, 7.9, 9.8, 11.8, 13.8, 15.7, 17.7, 19.7, 21.7, 23.6, 25.6, 27.6, 29.5, 31.5, 33.5, 35.4, 37.4, 39.4];
        var HEIGHT_INCREMENTS = [2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.9, 10.0, 11.1, 12.2, 13.3, 14.4, 15.5, 16.6, 17.7, 18.9, 20.0, 21.1];
        
        // Correct pixel pitches: 0.9, 1.25, 1.9, 2.6
        var PRICING = {
            0.9:  { costPerSqft: 450, minViewingFt: 6,  label: 'Ultra HD' },
            1.25: { costPerSqft: 320, minViewingFt: 10, label: 'Premium' },
            1.9:  { costPerSqft: 200, minViewingFt: 15, label: 'Standard' },
            2.6:  { costPerSqft: 140, minViewingFt: 20, label: 'Value' }
        };
        
        var MARGIN_DIVISOR = 0.218;
        var FT_TO_M = 0.3048;
        var FRAME_DEPTH_M = 0.0635; // 2.5 inches in meters
        
        var state = { shape: 'rectangle', width: 13.8, height: 7.7, pixelPitch: 1.9, genre: 'sports' };
        var currentUsdzUrl = null;
        var loadedImages = {};
        
        var previewCanvas = document.getElementById('previewCanvas');
        var previewCtx = previewCanvas.getContext('2d');
        var textureCanvas = document.getElementById('textureCanvas');
        var textureCtx = textureCanvas.getContext('2d');
        
        function loadImage(genre) {
            return new Promise(function(resolve) {
                if (loadedImages[genre]) {
                    resolve(loadedImages[genre]);
                    return;
                }
                var img = new Image();
                img.onload = function() {
                    loadedImages[genre] = img;
                    resolve(img);
                };
                img.onerror = function() {
                    resolve(null);
                };
                img.src = IMAGE_PATHS[genre];
            });
        }
        
        Object.keys(IMAGE_PATHS).forEach(loadImage);
        
        function snapToIncrement(value, increments) {
            return increments.reduce(function(prev, curr) {
                return Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev;
            });
        }
        
        function getIncrementIndex(value, increments) {
            for (var i = 0; i < increments.length; i++) {
                if (Math.abs(increments[i] - value) < 0.1) return i;
            }
            return 0;
        }
        
        function findBestHeightForRatio(width, targetRatio) {
            return snapToIncrement(width / targetRatio, HEIGHT_INCREMENTS);
        }
        
        function getCostPerSqft(sqft, pitch) {
            var baseCost = PRICING[pitch].costPerSqft;
            if (sqft >= 175) return baseCost * 0.78;
            if (sqft >= 120) return baseCost * 0.85;
            if (sqft >= 80) return baseCost * 0.92;
            return baseCost;
        }
        
        function calculateDisplayPrice(width, height, pitch) {
            var sqft = width * height;
            var cost = getCostPerSqft(sqft, pitch) * sqft;
            return Math.floor((cost / MARGIN_DIVISOR) / 10000) * 10000;
        }
        
        function formatPrice(price) {
            if (price < 10000) price = 10000;
            return '$' + price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '+';
        }
        
        function calcResolution(widthFt, heightFt, pitchMM) {
            var wMM = widthFt * 304.8;
            var hMM = heightFt * 304.8;
            return { w: Math.round(wMM / pitchMM), h: Math.round(hMM / pitchMM) };
        }
        
        // Draw image with proper center crop and LED pixel grid
        function drawLEDScreen(ctx, img, canvasW, canvasH, screenWidthFt, screenHeightFt, pitchMM) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvasW, canvasH);
            
            if (!img) return;
            
            // Center crop the image to match screen aspect ratio
            var screenAspect = screenWidthFt / screenHeightFt;
            var imgAspect = img.width / img.height;
            
            var srcX, srcY, srcW, srcH;
            
            if (imgAspect > screenAspect) {
                // Image is wider than screen - crop left/right
                srcH = img.height;
                srcW = img.height * screenAspect;
                srcX = (img.width - srcW) / 2;
                srcY = 0;
            } else {
                // Image is taller than screen - crop top/bottom
                srcW = img.width;
                srcH = img.width / screenAspect;
                srcX = 0;
                srcY = (img.height - srcH) / 2;
            }
            
            // Draw cropped image to fill canvas
            ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, canvasW, canvasH);
            
            // Calculate LED pixel grid
            // How many pixels fit across the screen width?
            var screenWidthMM = screenWidthFt * 304.8;
            var numPixelsAcross = Math.floor(screenWidthMM / pitchMM);
            var pixelSizeOnCanvas = canvasW / numPixelsAcross;
            
            // Only draw grid if pixels are large enough to see (> 2px)
            if (pixelSizeOnCanvas > 2) {
                // LED pixels have gaps between them - typically ~15% of pitch
                var gapRatio = 0.15;
                var gapSize = Math.max(0.5, pixelSizeOnCanvas * gapRatio);
                
                ctx.fillStyle = '#000';
                
                // Draw vertical black lines (gaps between LED columns)
                for (var x = pixelSizeOnCanvas; x < canvasW; x += pixelSizeOnCanvas) {
                    ctx.fillRect(Math.round(x - gapSize/2), 0, Math.ceil(gapSize), canvasH);
                }
                
                // Draw horizontal black lines (gaps between LED rows)
                for (var y = pixelSizeOnCanvas; y < canvasH; y += pixelSizeOnCanvas) {
                    ctx.fillRect(0, Math.round(y - gapSize/2), canvasW, Math.ceil(gapSize));
                }
            }
        }
        
        // Generate texture for USDZ
        function generateTexture(img, widthFt, heightFt, pitchMM) {
            var aspectRatio = widthFt / heightFt;
            var texW = 2048;
            var texH = Math.round(texW / aspectRatio);
            
            textureCanvas.width = texW;
            textureCanvas.height = texH;
            
            drawLEDScreen(textureCtx, img, texW, texH, widthFt, heightFt, pitchMM);
            
            return textureCanvas.toDataURL('image/jpeg', 0.92);
        }
        
        // Generate proper USDA with 3D cabinet frame
        function generateUSDA(widthM, heightM) {
            var w = widthM / 2;  // half width
            var h = heightM / 2; // half height
            var d = FRAME_DEPTH_M;
            var f = 0.02; // frame thickness (visible edge)
            
            // Cabinet is a box: back + 4 sides, with screen on front
            var usda = '#usda 1.0\n';
            usda += '(\n    defaultPrim = "LEDWall"\n    metersPerUnit = 1\n    upAxis = "Y"\n)\n\n';
            usda += 'def Xform "LEDWall" (\n    kind = "component"\n)\n{\n';
            
            // CABINET - Back panel
            usda += '    def Mesh "CabinetBack"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 2, 3, 1]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', ' + (-d).toFixed(4) + ')\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // CABINET - Top side
            usda += '    def Mesh "CabinetTop"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', ' + (-d).toFixed(4) + ')\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // CABINET - Bottom side
            usda += '    def Mesh "CabinetBottom"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 2, 3, 1]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', ' + (-d).toFixed(4) + ')\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // CABINET - Left side
            usda += '    def Mesh "CabinetLeft"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 2, 3, 1]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', ' + (-d).toFixed(4) + ')\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // CABINET - Right side
            usda += '    def Mesh "CabinetRight"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', ' + (-d).toFixed(4) + '),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', ' + (-d).toFixed(4) + ')\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // CABINET - Front bezel (frame around screen)
            // Top bezel
            usda += '    def Mesh "BezelTop"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + h.toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + h.toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (h+f).toFixed(4) + ', 0)\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // Bottom bezel
            usda += '    def Mesh "BezelBottom"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h-f).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h).toFixed(4) + ', 0)\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // Left bezel
            usda += '    def Mesh "BezelLeft"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + (-h).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w).toFixed(4) + ', ' + (-h).toFixed(4) + ', 0),\n';
            usda += '            (' + (-w-f).toFixed(4) + ', ' + h.toFixed(4) + ', 0),\n';
            usda += '            (' + (-w).toFixed(4) + ', ' + h.toFixed(4) + ', 0)\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // Right bezel
            usda += '    def Mesh "BezelRight"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + w.toFixed(4) + ', ' + (-h).toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + (-h).toFixed(4) + ', 0),\n';
            usda += '            (' + w.toFixed(4) + ', ' + h.toFixed(4) + ', 0),\n';
            usda += '            (' + (w+f).toFixed(4) + ', ' + h.toFixed(4) + ', 0)\n';
            usda += '        ]\n';
            usda += '        rel material:binding = </LEDWall/Materials/CabinetMat>\n';
            usda += '    }\n\n';
            
            // SCREEN - LED display surface
            usda += '    def Mesh "Screen"\n    {\n';
            usda += '        int[] faceVertexCounts = [4]\n';
            usda += '        int[] faceVertexIndices = [0, 1, 3, 2]\n';
            usda += '        point3f[] points = [\n';
            usda += '            (' + (-w).toFixed(4) + ', ' + (-h).toFixed(4) + ', 0.002),\n';
            usda += '            (' + w.toFixed(4) + ', ' + (-h).toFixed(4) + ', 0.002),\n';
            usda += '            (' + (-w).toFixed(4) + ', ' + h.toFixed(4) + ', 0.002),\n';
            usda += '            (' + w.toFixed(4) + ', ' + h.toFixed(4) + ', 0.002)\n';
            usda += '        ]\n';
            usda += '        texCoord2f[] primvars:st = [(0, 0), (1, 0), (0, 1), (1, 1)] (\n';
            usda += '            interpolation = "vertex"\n';
            usda += '        )\n';
            usda += '        int[] primvars:st:indices = [0, 1, 3, 2]\n';
            usda += '        rel material:binding = </LEDWall/Materials/ScreenMat>\n';
            usda += '    }\n\n';
            
            // MATERIALS
            usda += '    def Scope "Materials"\n    {\n';
            
            // Cabinet material - matte black metal
            usda += '        def Material "CabinetMat"\n        {\n';
            usda += '            token outputs:surface.connect = </LEDWall/Materials/CabinetMat/Shader.outputs:surface>\n';
            usda += '            def Shader "Shader"\n            {\n';
            usda += '                uniform token info:id = "UsdPreviewSurface"\n';
            usda += '                color3f inputs:diffuseColor = (0.015, 0.015, 0.015)\n';
            usda += '                float inputs:roughness = 0.6\n';
            usda += '                float inputs:metallic = 0.4\n';
            usda += '                token outputs:surface\n';
            usda += '            }\n';
            usda += '        }\n\n';
            
            // Screen material - emissive texture (no reflections)
            usda += '        def Material "ScreenMat"\n        {\n';
            usda += '            token outputs:surface.connect = </LEDWall/Materials/ScreenMat/Shader.outputs:surface>\n';
            usda += '            def Shader "Shader"\n            {\n';
            usda += '                uniform token info:id = "UsdPreviewSurface"\n';
            usda += '                color3f inputs:diffuseColor = (0, 0, 0)\n';
            usda += '                color3f inputs:emissiveColor.connect = </LEDWall/Materials/ScreenMat/Tex.outputs:rgb>\n';
            usda += '                float inputs:roughness = 1\n';
            usda += '                float inputs:metallic = 0\n';
            usda += '                token outputs:surface\n';
            usda += '            }\n';
            usda += '            def Shader "Tex"\n            {\n';
            usda += '                uniform token info:id = "UsdUVTexture"\n';
            usda += '                asset inputs:file = @texture.jpg@\n';
            usda += '                float2 inputs:st.connect = </LEDWall/Materials/ScreenMat/UV.outputs:result>\n';
            usda += '                token inputs:wrapS = "clamp"\n';
            usda += '                token inputs:wrapT = "clamp"\n';
            usda += '                float3 outputs:rgb\n';
            usda += '            }\n';
            usda += '            def Shader "UV"\n            {\n';
            usda += '                uniform token info:id = "UsdPrimvarReader_float2"\n';
            usda += '                string inputs:varname = "st"\n';
            usda += '                float2 outputs:result\n';
            usda += '            }\n';
            usda += '        }\n';
            usda += '    }\n';
            usda += '}\n';
            
            return usda;
        }
        
        async function generateUSDZ() {
            var widthM = state.width * FT_TO_M;
            var heightM = state.height * FT_TO_M;
            
            var img = await loadImage(state.genre);
            
            var usdaContent = generateUSDA(widthM, heightM);
            var textureDataUrl = generateTexture(img, state.width, state.height, state.pixelPitch);
            var textureBase64 = textureDataUrl.split(',')[1];
            var textureBytes = Uint8Array.from(atob(textureBase64), function(c) { return c.charCodeAt(0); });
            
            var zip = new JSZip();
            zip.file('model.usda', usdaContent);
            zip.file('texture.jpg', textureBytes);
            
            var arrayBuffer = await zip.generateAsync({type: 'arraybuffer', compression: 'STORE'});
            var blob = new Blob([arrayBuffer], {type: 'model/vnd.usdz+zip'});
            
            if (currentUsdzUrl) URL.revokeObjectURL(currentUsdzUrl);
            currentUsdzUrl = URL.createObjectURL(blob);
            return currentUsdzUrl + '#.usdz';
        }
        
        function updatePreview() {
            var maxW = 320;
            var aspect = state.width / state.height;
            var w = maxW;
            var h = Math.round(w / aspect);
            
            if (h > 220) {
                h = 220;
                w = Math.round(h * aspect);
            }
            
            previewCanvas.width = w * 2;
            previewCanvas.height = h * 2;
            previewCanvas.style.width = w + 'px';
            previewCanvas.style.height = h + 'px';
            
            var img = loadedImages[state.genre];
            drawLEDScreen(previewCtx, img, w * 2, h * 2, state.width, state.height, state.pixelPitch);
        }
        
        async function updateUI() {
            document.getElementById('widthValue').textContent = state.width + ' ft';
            document.getElementById('heightValue').textContent = state.height + ' ft';
            
            var price = calculateDisplayPrice(state.width, state.height, state.pixelPitch);
            var pricingInfo = PRICING[state.pixelPitch];
            document.getElementById('priceDisplay').textContent = formatPrice(price);
            document.getElementById('pitchLabel').textContent = 'P' + state.pixelPitch + ' ' + pricingInfo.label;
            document.getElementById('pitchPreview').textContent = 'P' + state.pixelPitch;
            document.getElementById('viewingDistance').textContent = pricingInfo.minViewingFt + '+ feet';
            
            var res = calcResolution(state.width, state.height, state.pixelPitch);
            var total = res.w * res.h;
            var sqft = Math.round(state.width * state.height);
            document.getElementById('resolutionSpec').textContent = res.w + ' x ' + res.h;
            document.getElementById('pixelsSpec').textContent = total >= 1000000 ? (total / 1000000).toFixed(2) + 'M' : Math.round(total / 1000) + 'K';
            document.getElementById('areaSpec').textContent = sqft + ' sq ft';
            document.getElementById('genreDescription').textContent = GENRES[state.genre].description;
            document.getElementById('arDimensions').textContent = state.width + ' ft × ' + state.height + ' ft';
            
            await loadImage(state.genre);
            updatePreview();
            
            var arLink = document.getElementById('arLink');
            var arButton = document.getElementById('arButtonText');
            arLink.classList.add('loading');
            arButton.textContent = 'Generating...';
            
            try {
                var url = await generateUSDZ();
                arLink.href = url;
                arButton.textContent = 'View in Your Space';
                arLink.classList.remove('loading');
            } catch(e) {
                console.error('USDZ error:', e);
                arButton.textContent = 'View in Your Space';
                arLink.classList.remove('loading');
            }
        }
        
        var updateTimeout = null;
        function debouncedUpdate() {
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updateUI, 150);
        }
        
        document.querySelectorAll('[data-shape]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-shape]').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                state.shape = btn.dataset.shape;
                var widthSlider = document.getElementById('widthSlider');
                var heightSlider = document.getElementById('heightSlider');
                if (state.shape === 'custom') {
                    heightSlider.disabled = false;
                } else {
                    heightSlider.disabled = true;
                    state.width = WIDTH_INCREMENTS[parseInt(widthSlider.value)];
                    if (state.shape === 'rectangle') state.height = findBestHeightForRatio(state.width, 16/9);
                    else if (state.shape === 'square') state.height = snapToIncrement(state.width, HEIGHT_INCREMENTS);
                    else if (state.shape === 'ultrawide') state.height = findBestHeightForRatio(state.width, 21/9);
                    heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
                }
                debouncedUpdate();
            });
        });
        
        document.querySelectorAll('[data-pitch]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-pitch]').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                state.pixelPitch = parseFloat(btn.dataset.pitch);
                debouncedUpdate();
            });
        });
        
        document.querySelectorAll('[data-genre]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-genre]').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                state.genre = btn.dataset.genre;
                debouncedUpdate();
            });
        });
        
        document.getElementById('widthSlider').addEventListener('input', function(e) {
            state.width = WIDTH_INCREMENTS[parseInt(e.target.value)];
            if (state.shape !== 'custom') {
                var heightSlider = document.getElementById('heightSlider');
                if (state.shape === 'rectangle') state.height = findBestHeightForRatio(state.width, 16/9);
                else if (state.shape === 'square') state.height = snapToIncrement(state.width, HEIGHT_INCREMENTS);
                else if (state.shape === 'ultrawide') state.height = findBestHeightForRatio(state.width, 21/9);
                heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
            }
            debouncedUpdate();
        });
        
        document.getElementById('heightSlider').addEventListener('input', function(e) {
            if (state.shape === 'custom') {
                state.height = HEIGHT_INCREMENTS[parseInt(e.target.value)];
                debouncedUpdate();
            }
        });
        
        updateUI();
    </script>
</body>
</html>
