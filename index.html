<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Prestige Visual System - AR LED Video Wall Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0a0a1a 0%, #0f1a2a 50%, #0a0a0f 100%); color: #fff; -webkit-user-select: none; user-select: none; }
        
        .container { min-height: 100%; padding: 20px; padding-bottom: 100px; }
        
        .header { text-align: center; padding: 30px 0; }
        .logo-text { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #00a8ff, #00ffcc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo-subtitle { font-size: 12px; color: rgba(0,200,255,0.7); text-transform: uppercase; letter-spacing: 6px; margin-top: 5px; }
        
        .preview-section { background: rgba(0,0,0,0.4); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,200,255,0.2); }
        .preview-container { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        #previewCanvas { width: 100%; height: 100%; display: block; }
        .preview-label { text-align: center; font-size: 12px; color: rgba(255,255,255,0.5); }
        
        .ar-button { display: flex; width: 100%; padding: 18px; font-size: 18px; font-weight: 700; color: #000; background: linear-gradient(135deg, #00ff88, #00d4ff); border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .ar-button:active { transform: scale(0.98); }
        .ar-button.loading { background: linear-gradient(135deg, #888, #666); pointer-events: none; }
        .ar-button svg { width: 24px; height: 24px; }
        
        .ar-note { text-align: center; font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 20px; }
        #arDimensions { color: #00d4ff; font-weight: 600; }
        
        .config-section { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(0,200,255,0.15); }
        .section-title { font-size: 11px; color: #00d4ff; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; font-weight: 600; }
        
        .pricing-display { text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(0,200,100,0.15), rgba(0,150,255,0.1)); border-radius: 12px; border: 1px solid rgba(0,255,150,0.3); margin-bottom: 15px; }
        .price { font-size: 42px; font-weight: 800; color: #00ff88; }
        .price-details { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 5px; }
        .price-details span { color: #00d4ff; font-weight: 600; }
        .viewing-distance { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .viewing-distance strong { color: #ffcc00; }
        
        .button-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .option-btn { padding: 12px 8px; background: rgba(0,100,200,0.15); border: 1px solid rgba(0,200,255,0.2); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
        .option-btn.active { background: rgba(0,150,255,0.4); border-color: #00d4ff; color: #fff; }
        .option-btn small { display: block; font-size: 9px; color: rgba(255,255,255,0.4); margin-top: 3px; font-weight: 400; }
        .option-btn.active small { color: rgba(255,255,255,0.7); }
        
        .slider-group { margin-bottom: 15px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .slider-label { font-size: 12px; color: rgba(255,255,255,0.6); }
        .slider-value { font-size: 16px; color: #00d4ff; font-weight: 700; }
        input[type="range"] { width: 100%; height: 8px; -webkit-appearance: none; background: rgba(0,100,200,0.3); border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: linear-gradient(135deg, #00a8ff, #00d4aa); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,200,255,0.4); }
        input[type="range"]:disabled { opacity: 0.4; }
        
        .genre-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px; }
        .genre-btn { padding: 10px 6px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .genre-btn.active { background: #fff; border-color: #fff; color: #0a0a0f; }
        .genre-description { text-align: center; font-size: 11px; color: rgba(0,200,255,0.8); font-style: italic; padding: 5px 0; }
        
        .specs-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .spec-box { background: rgba(0,150,255,0.1); border: 1px solid rgba(0,200,255,0.15); border-radius: 10px; padding: 12px; text-align: center; }
        .spec-label { font-size: 9px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 4px; }
        .spec-value { font-size: 14px; color: #00d4ff; font-weight: 600; }
        
        .disclaimer { font-size: 10px; color: rgba(255,255,255,0.4); text-align: center; line-height: 1.5; padding: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-text">Prestige Visual</div>
            <div class="logo-subtitle">System</div>
        </div>
        
        <div class="preview-section">
            <div class="preview-container">
                <canvas id="previewCanvas"></canvas>
            </div>
            <div class="preview-label">Preview - Select content type below</div>
        </div>
        
        <a id="arLink" rel="ar" href="#" class="ar-button">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4v6h2V6h4V4H3zm18 0h-6v2h4v4h2V4zm-2 14h-4v2h6v-6h-2v4zM5 18v-4H3v6h6v-2H5zm7-12L5.5 9.5 12 13l6.5-3.5L12 6zm0 8.5l-5.5-3v3L12 18l5.5-3.5v-3L12 14.5z"/></svg>
            <span id="arButtonText">View in Your Space</span>
            <img id="arImg" style="display:none;">
        </a>
        
        <div class="ar-note">Opens iOS AR viewer · Size: <span id="arDimensions">13.8 ft × 7.7 ft</span></div>
        
        <div class="config-section">
            <div class="section-title">Pricing</div>
            <div class="pricing-display">
                <div class="price" id="priceDisplay">$80,000+</div>
                <div class="price-details">Estimated starting price · <span id="pitchLabel">P1.9 Standard</span></div>
                <div class="viewing-distance">Recommended viewing: <strong id="viewingDistance">15+ feet</strong></div>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Screen Shape</div>
            <div class="button-grid">
                <button class="option-btn active" data-shape="rectangle">Rectangle<small>16:9</small></button>
                <button class="option-btn" data-shape="square">Square<small>1:1</small></button>
                <button class="option-btn" data-shape="ultrawide">Ultrawide<small>21:9</small></button>
                <button class="option-btn" data-shape="custom">Custom<small id="customRatio">Free</small></button>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Dimensions</div>
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Width</span>
                    <span class="slider-value" id="widthValue">13.8 ft</span>
                </div>
                <input type="range" id="widthSlider" min="0" max="18" value="5" step="1">
            </div>
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Height</span>
                    <span class="slider-value" id="heightValue">7.7 ft</span>
                </div>
                <input type="range" id="heightSlider" min="0" max="17" value="5" step="1">
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Pixel Pitch</div>
            <div class="button-grid">
                <button class="option-btn" data-pitch="0.9">0.9mm<small>Ultra-Premium</small></button>
                <button class="option-btn" data-pitch="1.25">1.25mm<small>Premium</small></button>
                <button class="option-btn active" data-pitch="1.9">1.9mm<small>Standard</small></button>
                <button class="option-btn" data-pitch="2.6">2.6mm<small>Commercial</small></button>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Content Preview</div>
            <div class="genre-grid">
                <button class="genre-btn" data-genre="worship">Worship</button>
                <button class="genre-btn" data-genre="corporate">Corporate</button>
                <button class="genre-btn" data-genre="sports">Sports</button>
                <button class="genre-btn" data-genre="cinema">Cinema</button>
                <button class="genre-btn" data-genre="concert">Concert</button>
                <button class="genre-btn" data-genre="retail">Retail</button>
                <button class="genre-btn active" data-genre="nature">Nature</button>
            </div>
            <div class="genre-description" id="genreDescription">Ambient & Demo Content</div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Specifications</div>
            <div class="specs-row">
                <div class="spec-box"><div class="spec-label">Resolution</div><div class="spec-value" id="resolutionSpec">2252 x 1267</div></div>
                <div class="spec-box"><div class="spec-label">Total Pixels</div><div class="spec-value" id="pixelsSpec">2.85M</div></div>
                <div class="spec-box"><div class="spec-label">Area</div><div class="spec-value" id="areaSpec">106 sq ft</div></div>
            </div>
        </div>
        
        <div class="disclaimer">
            Pricing is an estimate based on selected dimensions. Actual panel configurations and final pricing confirmed during consultation.
        </div>
    </div>
    
    <canvas id="textureCanvas" style="display:none;"></canvas>

    <script>
        var GENRES = {
            worship: { label: 'Worship', description: 'Churches & Houses of Worship' },
            corporate: { label: 'Corporate', description: 'Lobbies & Boardrooms' },
            sports: { label: 'Sports', description: 'Sports Bars & Game Day' },
            cinema: { label: 'Cinema', description: 'Home Theater & Media Rooms' },
            concert: { label: 'Concert', description: 'Live Events & Nightclubs' },
            retail: { label: 'Retail', description: 'Stores & Commercial Signage' },
            nature: { label: 'Nature', description: 'Ambient & Demo Content' }
        };
        
        var WIDTH_INCREMENTS = [3.9, 5.9, 7.9, 9.8, 11.8, 13.8, 15.7, 17.7, 19.7, 21.7, 23.6, 25.6, 27.6, 29.5, 31.5, 33.5, 35.4, 37.4, 39.4];
        var HEIGHT_INCREMENTS = [2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.9, 10.0, 11.1, 12.2, 13.3, 14.4, 15.5, 16.6, 17.7, 18.9, 20.0, 21.1];
        
        var PRICING = {
            'P0.9':  { costPerSqft: 385, minViewingFt: 7,  label: 'Ultra-Premium' },
            'P1.25': { costPerSqft: 212, minViewingFt: 10, label: 'Premium' },
            'P1.9':  { costPerSqft: 185, minViewingFt: 15, label: 'Standard' },
            'P2.6':  { costPerSqft: 140, minViewingFt: 21, label: 'Commercial' }
        };
        
        var MARGIN_DIVISOR = 0.218;
        var FT_TO_M = 0.3048;
        
        var state = { shape: 'rectangle', width: 13.8, height: 7.7, pixelPitch: 1.9, genre: 'nature' };
        var currentUsdzUrl = null;
        
        var previewCanvas = document.getElementById('previewCanvas');
        var previewCtx = previewCanvas.getContext('2d');
        var textureCanvas = document.getElementById('textureCanvas');
        var textureCtx = textureCanvas.getContext('2d');
        var frameCount = 0;
        
        function snapToIncrement(value, increments) {
            return increments.reduce(function(prev, curr) {
                return Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev;
            });
        }
        
        function getIncrementIndex(value, increments) {
            for (var i = 0; i < increments.length; i++) {
                if (Math.abs(increments[i] - value) < 0.1) return i;
            }
            return 0;
        }
        
        function findBestHeightForRatio(width, targetRatio) {
            return snapToIncrement(width / targetRatio, HEIGHT_INCREMENTS);
        }
        
        function getPitchKey(pitch) {
            if (pitch === 0.9) return 'P0.9';
            if (pitch === 1.25) return 'P1.25';
            if (pitch === 1.9) return 'P1.9';
            if (pitch === 2.6) return 'P2.6';
            return 'P1.9';
        }
        
        function getCostPerSqft(sqft, pitchKey) {
            var baseCost = PRICING[pitchKey].costPerSqft;
            if (sqft >= 175) return baseCost * 0.78;
            if (sqft >= 120) return baseCost * 0.85;
            if (sqft >= 80) return baseCost * 0.92;
            return baseCost;
        }
        
        function calculateDisplayPrice(width, height, pitch) {
            var key = getPitchKey(pitch);
            var sqft = width * height;
            var cost = getCostPerSqft(sqft, key) * sqft;
            return Math.floor((cost / MARGIN_DIVISOR) / 10000) * 10000;
        }
        
        function formatPrice(price) {
            if (price < 10000) price = 10000;
            return '$' + price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '+';
        }
        
        function calcResolution(pitch) {
            var wMM = state.width * 304.8;
            var hMM = state.height * 304.8;
            return { w: Math.round(wMM / pitch), h: Math.round(hMM / pitch) };
        }
        
        function generateUSDA(widthM, heightM, depthM) {
            var hw = widthM / 2;
            var hh = heightM / 2;
            var hd = depthM / 2;
            var fo = 0.03;
            
            return '#usda 1.0\n(\n    defaultPrim = "LEDWall"\n    metersPerUnit = 1\n    upAxis = "Y"\n)\n\ndef Xform "LEDWall" (\n    assetInfo = {\n        string name = "LED Video Wall"\n    }\n    kind = "component"\n)\n{\n    def Mesh "Frame"\n    {\n        float3[] extent = [(' + (-(hw+fo)).toFixed(4) + ', ' + (-(hh+fo)).toFixed(4) + ', ' + (-hd).toFixed(4) + '), (' + (hw+fo).toFixed(4) + ', ' + (hh+fo).toFixed(4) + ', ' + hd.toFixed(4) + ')]\n        int[] faceVertexCounts = [4, 4, 4, 4, 4, 4]\n        int[] faceVertexIndices = [0, 1, 3, 2, 4, 6, 7, 5, 0, 4, 5, 1, 2, 3, 7, 6, 0, 2, 6, 4, 1, 5, 7, 3]\n        point3f[] points = [\n            (' + (-(hw+fo)).toFixed(4) + ', ' + (-(hh+fo)).toFixed(4) + ', ' + hd.toFixed(4) + '),\n            (' + (hw+fo).toFixed(4) + ', ' + (-(hh+fo)).toFixed(4) + ', ' + hd.toFixed(4) + '),\n            (' + (-(hw+fo)).toFixed(4) + ', ' + (hh+fo).toFixed(4) + ', ' + hd.toFixed(4) + '),\n            (' + (hw+fo).toFixed(4) + ', ' + (hh+fo).toFixed(4) + ', ' + hd.toFixed(4) + '),\n            (' + (-(hw+fo)).toFixed(4) + ', ' + (-(hh+fo)).toFixed(4) + ', ' + (-hd).toFixed(4) + '),\n            (' + (hw+fo).toFixed(4) + ', ' + (-(hh+fo)).toFixed(4) + ', ' + (-hd).toFixed(4) + '),\n            (' + (-(hw+fo)).toFixed(4) + ', ' + (hh+fo).toFixed(4) + ', ' + (-hd).toFixed(4) + '),\n            (' + (hw+fo).toFixed(4) + ', ' + (hh+fo).toFixed(4) + ', ' + (-hd).toFixed(4) + ')\n        ]\n        color3f[] primvars:displayColor = [(0.1, 0.1, 0.1)]\n        uniform token subdivisionScheme = "none"\n        rel material:binding = </LEDWall/Materials/FrameMaterial>\n    }\n    \n    def Mesh "Screen"\n    {\n        float3[] extent = [(' + (-hw).toFixed(4) + ', ' + (-hh).toFixed(4) + ', ' + (hd+0.003).toFixed(4) + '), (' + hw.toFixed(4) + ', ' + hh.toFixed(4) + ', ' + (hd+0.003).toFixed(4) + ')]\n        int[] faceVertexCounts = [4]\n        int[] faceVertexIndices = [0, 1, 3, 2]\n        point3f[] points = [\n            (' + (-hw).toFixed(4) + ', ' + (-hh).toFixed(4) + ', ' + (hd+0.003).toFixed(4) + '),\n            (' + hw.toFixed(4) + ', ' + (-hh).toFixed(4) + ', ' + (hd+0.003).toFixed(4) + '),\n            (' + (-hw).toFixed(4) + ', ' + hh.toFixed(4) + ', ' + (hd+0.003).toFixed(4) + '),\n            (' + hw.toFixed(4) + ', ' + hh.toFixed(4) + ', ' + (hd+0.003).toFixed(4) + ')\n        ]\n        texCoord2f[] primvars:st = [(0, 0), (1, 0), (0, 1), (1, 1)] (\n            interpolation = "vertex"\n        )\n        int[] primvars:st:indices = [0, 1, 3, 2]\n        uniform token subdivisionScheme = "none"\n        rel material:binding = </LEDWall/Materials/ScreenMaterial>\n    }\n    \n    def Scope "Materials"\n    {\n        def Material "FrameMaterial"\n        {\n            token outputs:surface.connect = </LEDWall/Materials/FrameMaterial/PBRShader.outputs:surface>\n            def Shader "PBRShader"\n            {\n                uniform token info:id = "UsdPreviewSurface"\n                color3f inputs:diffuseColor = (0.1, 0.1, 0.1)\n                float inputs:roughness = 0.8\n                float inputs:metallic = 0.2\n                token outputs:surface\n            }\n        }\n        \n        def Material "ScreenMaterial"\n        {\n            token outputs:surface.connect = </LEDWall/Materials/ScreenMaterial/PBRShader.outputs:surface>\n            def Shader "PBRShader"\n            {\n                uniform token info:id = "UsdPreviewSurface"\n                color3f inputs:diffuseColor.connect = </LEDWall/Materials/ScreenMaterial/Texture.outputs:rgb>\n                color3f inputs:emissiveColor.connect = </LEDWall/Materials/ScreenMaterial/Texture.outputs:rgb>\n                float inputs:roughness = 0.3\n                float inputs:metallic = 0.0\n                token outputs:surface\n            }\n            def Shader "Texture"\n            {\n                uniform token info:id = "UsdUVTexture"\n                asset inputs:file = @texture.png@\n                float2 inputs:st.connect = </LEDWall/Materials/ScreenMaterial/TexCoordReader.outputs:result>\n                token inputs:wrapS = "clamp"\n                token inputs:wrapT = "clamp"\n                float3 outputs:rgb\n            }\n            def Shader "TexCoordReader"\n            {\n                uniform token info:id = "UsdPrimvarReader_float2"\n                string inputs:varname = "st"\n                float2 outputs:result\n            }\n        }\n    }\n}\n';
        }
        
        function generateTexture(genre, width, height) {
            var aspectRatio = width / height;
            var texW = 1024;
            var texH = Math.round(texW / aspectRatio);
            textureCanvas.width = texW;
            textureCanvas.height = texH;
            var ctx = textureCtx;
            var w = texW, h = texH;
            
            if (genre === 'worship') {
                var bg = ctx.createLinearGradient(0, 0, 0, h);
                bg.addColorStop(0, '#1a0a30'); bg.addColorStop(0.5, '#2a1a50'); bg.addColorStop(1, '#4a3020');
                ctx.fillStyle = bg; ctx.fillRect(0, 0, w, h);
                for (var i = 0; i < 8; i++) {
                    ctx.globalAlpha = 0.15;
                    var rayX = w * 0.5 + Math.sin(i*0.8) * w * 0.25;
                    var rg = ctx.createLinearGradient(rayX, h, rayX, 0);
                    rg.addColorStop(0, 'hsl(' + (280 + i*12) + ',70%,55%)'); rg.addColorStop(1, 'transparent');
                    ctx.fillStyle = rg;
                    ctx.beginPath(); ctx.moveTo(rayX - 50, h); ctx.lineTo(rayX - 15, 0); ctx.lineTo(rayX + 15, 0); ctx.lineTo(rayX + 50, h); ctx.fill();
                }
                ctx.globalAlpha = 1;
                ctx.fillStyle = 'rgba(255,220,150,0.4)';
                ctx.fillRect(w/2 - 12, h*0.45 - 100, 24, 200);
                ctx.fillRect(w/2 - 70, h*0.45 - 55, 140, 24);
            } else if (genre === 'corporate') {
                var bg = ctx.createLinearGradient(0, 0, w, h);
                bg.addColorStop(0, '#0a2540'); bg.addColorStop(1, '#0d47a1');
                ctx.fillStyle = bg; ctx.fillRect(0, 0, w, h);
                ctx.strokeStyle = 'rgba(100,200,255,0.15)'; ctx.lineWidth = 1;
                for (var gx = 0; gx < w; gx += 60) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
                for (var gy = 0; gy < h; gy += 60) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
                var bars = [0.6, 0.8, 0.5, 0.9, 0.7, 0.95, 0.75, 0.85];
                for (var b = 0; b < 8; b++) {
                    var bh = bars[b] * h * 0.5;
                    var bgr = ctx.createLinearGradient(0, h*0.85 - bh, 0, h*0.85);
                    bgr.addColorStop(0, '#00e5ff'); bgr.addColorStop(1, '#0066cc');
                    ctx.fillStyle = bgr; ctx.fillRect(w*0.1 + b * (w*0.1), h*0.85 - bh, w*0.07, bh);
                }
                ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.06) + 'px Arial'; ctx.textAlign = 'center';
                ctx.fillText('QUARTERLY REPORT', w/2, h*0.15);
            } else if (genre === 'sports') {
                var fg = ctx.createLinearGradient(0, 0, 0, h);
                fg.addColorStop(0, '#1b5e20'); fg.addColorStop(0.5, '#2e7d32'); fg.addColorStop(1, '#1b5e20');
                ctx.fillStyle = fg; ctx.fillRect(0, 0, w, h);
                var mx = w * 0.05, my = h * 0.15, fw = w - 2 * mx, fh = h - 2 * my;
                ctx.fillStyle = '#0033aa'; ctx.fillRect(mx, my, fw * 0.1, fh);
                ctx.fillStyle = '#aa0000'; ctx.fillRect(w - mx - fw * 0.1, my, fw * 0.1, fh);
                ctx.strokeStyle = 'rgba(255,255,255,0.9)'; ctx.lineWidth = 2;
                for (var i = 0; i <= 10; i++) { var x = mx + fw * 0.1 + fw * 0.8 * i / 10; ctx.beginPath(); ctx.moveTo(x, my); ctx.lineTo(x, h - my); ctx.stroke(); }
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.strokeRect(mx, my, fw, fh);
                ctx.fillStyle = 'rgba(0,0,0,0.95)'; ctx.fillRect(w*0.2, h*0.01, w*0.6, h*0.12);
                ctx.strokeStyle = '#ffc107'; ctx.lineWidth = 3; ctx.strokeRect(w*0.2, h*0.01, w*0.6, h*0.12);
                ctx.fillStyle = '#00ff00'; ctx.font = 'bold ' + Math.round(w*0.045) + 'px monospace'; ctx.textAlign = 'center';
                ctx.fillText('24', w*0.32, h*0.105); ctx.fillText('17', w*0.68, h*0.105);
            } else if (genre === 'concert') {
                ctx.fillStyle = '#080010'; ctx.fillRect(0, 0, w, h);
                var colors = ['#ff00ff','#00ffff','#ffff00','#ff0088','#00ff88','#8800ff'];
                for (var i = 0; i < 10; i++) {
                    ctx.globalAlpha = 0.25;
                    var ang = Math.sin(i*0.5) * 0.5;
                    var topX = w/2 + Math.tan(ang) * h;
                    var lg = ctx.createLinearGradient(w/2, h, topX, 0);
                    lg.addColorStop(0, colors[i % colors.length]); lg.addColorStop(1, 'transparent');
                    ctx.fillStyle = lg;
                    ctx.beginPath(); ctx.moveTo(w/2, h); ctx.lineTo(topX - w*0.06, 0); ctx.lineTo(topX + w*0.06, 0); ctx.closePath(); ctx.fill();
                }
                ctx.globalAlpha = 1;
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.moveTo(0, h);
                for (var cx = 0; cx <= w; cx += w*0.02) { ctx.lineTo(cx, h - (h*0.08 + Math.sin(cx*0.02) * h*0.03)); }
                ctx.lineTo(w, h); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.12) + 'px Arial'; ctx.textAlign = 'center';
                ctx.shadowColor = '#ff00ff'; ctx.shadowBlur = 30; ctx.fillText('LIVE', w/2, h*0.4); ctx.shadowBlur = 0;
            } else if (genre === 'retail') {
                var rg = ctx.createLinearGradient(0, 0, w, h);
                rg.addColorStop(0, '#e91e63'); rg.addColorStop(0.5, '#9c27b0'); rg.addColorStop(1, '#673ab7');
                ctx.fillStyle = rg; ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = '#d32f2f';
                ctx.beginPath(); ctx.moveTo(w*0.15, h*0.35); ctx.lineTo(w*0.85, h*0.35); ctx.lineTo(w*0.88, h*0.5); ctx.lineTo(w*0.85, h*0.65); ctx.lineTo(w*0.15, h*0.65); ctx.lineTo(w*0.12, h*0.5); ctx.closePath(); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.14) + 'px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('SALE', w/2, h*0.5);
                ctx.textBaseline = 'alphabetic'; ctx.font = 'bold ' + Math.round(w*0.045) + 'px Arial';
                ctx.fillText('UP TO 50% OFF', w/2, h*0.82);
            } else if (genre === 'cinema') {
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
                var lbH = h * 0.12, viewH = h - lbH * 2;
                var sky = ctx.createLinearGradient(0, lbH, 0, lbH + viewH * 0.6);
                sky.addColorStop(0, '#1a1a3a'); sky.addColorStop(1, '#8b4513');
                ctx.fillStyle = sky; ctx.fillRect(0, lbH, w, viewH * 0.6);
                var sunGlow = ctx.createRadialGradient(w*0.7, lbH + viewH*0.3, 0, w*0.7, lbH + viewH*0.3, w*0.15);
                sunGlow.addColorStop(0, 'rgba(255,200,100,1)'); sunGlow.addColorStop(0.4, 'rgba(255,150,50,0.5)'); sunGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = sunGlow; ctx.fillRect(0, lbH, w, viewH);
                ctx.fillStyle = '#1a1a2a'; ctx.beginPath(); ctx.moveTo(0, lbH + viewH * 0.6);
                ctx.lineTo(w*0.2, lbH + viewH * 0.4); ctx.lineTo(w*0.4, lbH + viewH * 0.55); ctx.lineTo(w*0.6, lbH + viewH * 0.35);
                ctx.lineTo(w*0.8, lbH + viewH * 0.5); ctx.lineTo(w, lbH + viewH * 0.45); ctx.lineTo(w, lbH + viewH); ctx.lineTo(0, lbH + viewH); ctx.fill();
                ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, lbH); ctx.fillRect(0, h - lbH, w, lbH);
            } else {
                var sky = ctx.createLinearGradient(0, 0, 0, h * 0.7);
                sky.addColorStop(0, '#0a0a20'); sky.addColorStop(0.5, '#1a3a4a'); sky.addColorStop(1, '#2a4a3a');
                ctx.fillStyle = sky; ctx.fillRect(0, 0, w, h);
                for (var a = 0; a < 5; a++) {
                    ctx.globalAlpha = 0.35;
                    var ag = ctx.createLinearGradient(0, h*0.1, 0, h*0.55);
                    ag.addColorStop(0, 'transparent'); ag.addColorStop(0.3, 'hsl(' + (120 + a*25) + ',80%,50%)');
                    ag.addColorStop(0.7, 'hsl(' + (180 + a*20) + ',70%,40%)'); ag.addColorStop(1, 'transparent');
                    ctx.fillStyle = ag; ctx.beginPath(); ctx.moveTo(0, h*0.15);
                    for (var ax = 0; ax <= w; ax += 15) { ctx.lineTo(ax, h*0.28 + Math.sin(ax*0.012 + a*0.8) * h*0.08); }
                    ctx.lineTo(w, h*0.55); ctx.lineTo(0, h*0.55); ctx.fill();
                }
                ctx.globalAlpha = 1;
                ctx.fillStyle = '#1a1a2e'; ctx.beginPath(); ctx.moveTo(0, h); ctx.lineTo(0, h*0.72);
                ctx.lineTo(w*0.12, h*0.52); ctx.lineTo(w*0.28, h*0.68); ctx.lineTo(w*0.48, h*0.38);
                ctx.lineTo(w*0.68, h*0.58); ctx.lineTo(w*0.85, h*0.42); ctx.lineTo(w, h*0.58); ctx.lineTo(w, h); ctx.fill();
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.beginPath(); ctx.moveTo(w*0.48, h*0.38); ctx.lineTo(w*0.42, h*0.50); ctx.lineTo(w*0.54, h*0.50); ctx.fill();
                ctx.beginPath(); ctx.moveTo(w*0.85, h*0.42); ctx.lineTo(w*0.79, h*0.52); ctx.lineTo(w*0.91, h*0.52); ctx.fill();
                var lake = ctx.createLinearGradient(0, h*0.82, 0, h);
                lake.addColorStop(0, 'rgba(20,50,70,0.9)'); lake.addColorStop(1, 'rgba(10,30,50,0.95)');
                ctx.fillStyle = lake; ctx.fillRect(0, h*0.82, w, h*0.18);
            }
            return textureCanvas.toDataURL('image/png');
        }
        
        async function generateUSDZ() {
            var widthM = state.width * FT_TO_M;
            var heightM = state.height * FT_TO_M;
            var depthM = 0.08;
            var usdaContent = generateUSDA(widthM, heightM, depthM);
            var textureDataUrl = generateTexture(state.genre, state.width, state.height);
            var textureBase64 = textureDataUrl.split(',')[1];
            var textureBytes = Uint8Array.from(atob(textureBase64), function(c) { return c.charCodeAt(0); });
            var zip = new JSZip();
            zip.file('model.usda', usdaContent);
            zip.file('texture.png', textureBytes);
            var arrayBuffer = await zip.generateAsync({type: 'arraybuffer', compression: 'STORE'});
            var blob = new Blob([arrayBuffer], {type: 'model/vnd.usdz+zip'});
            if (currentUsdzUrl) URL.revokeObjectURL(currentUsdzUrl);
            currentUsdzUrl = URL.createObjectURL(blob);
            return currentUsdzUrl + '#.usdz';
        }
        
        async function updateUI() {
            document.getElementById('widthValue').textContent = state.width + ' ft';
            document.getElementById('heightValue').textContent = state.height + ' ft';
            var price = calculateDisplayPrice(state.width, state.height, state.pixelPitch);
            var key = getPitchKey(state.pixelPitch);
            document.getElementById('priceDisplay').textContent = formatPrice(price);
            document.getElementById('pitchLabel').textContent = key + ' ' + PRICING[key].label;
            document.getElementById('viewingDistance').textContent = PRICING[key].minViewingFt + '+ feet';
            var res = calcResolution(state.pixelPitch);
            var total = res.w * res.h;
            var sqft = Math.round(state.width * state.height);
            document.getElementById('resolutionSpec').textContent = res.w + ' x ' + res.h;
            document.getElementById('pixelsSpec').textContent = total >= 1000000 ? (total / 1000000).toFixed(2) + 'M' : Math.round(total / 1000) + 'K';
            document.getElementById('areaSpec').textContent = sqft + ' sq ft';
            document.getElementById('genreDescription').textContent = GENRES[state.genre].description;
            document.getElementById('arDimensions').textContent = state.width + ' ft × ' + state.height + ' ft';
            var arLink = document.getElementById('arLink');
            var arButton = document.getElementById('arButtonText');
            arLink.classList.add('loading');
            arButton.textContent = 'Generating...';
            try {
                var url = await generateUSDZ();
                arLink.href = url;
                arButton.textContent = 'View in Your Space';
                arLink.classList.remove('loading');
            } catch(e) {
                console.error('USDZ generation failed:', e);
                arButton.textContent = 'View in Your Space';
                arLink.classList.remove('loading');
            }
        }
        
        function drawNature(ctx, w, h, t) {
            var sky = ctx.createLinearGradient(0, 0, 0, h * 0.7);
            sky.addColorStop(0, '#0a0a20'); sky.addColorStop(0.5, '#1a3a4a'); sky.addColorStop(1, '#2a4a3a');
            ctx.fillStyle = sky; ctx.fillRect(0, 0, w, h);
            for (var a = 0; a < 5; a++) {
                ctx.save(); ctx.globalAlpha = 0.3 + Math.sin(t*0.03 + a) * 0.15;
                var ag = ctx.createLinearGradient(0, h*0.1, 0, h*0.55);
                ag.addColorStop(0, 'transparent'); ag.addColorStop(0.3, 'hsl(' + (120 + a*25 + Math.sin(t*0.02)*20) + ',80%,50%)');
                ag.addColorStop(0.7, 'hsl(' + (180 + a*20 + Math.sin(t*0.025)*15) + ',70%,40%)'); ag.addColorStop(1, 'transparent');
                ctx.fillStyle = ag; ctx.beginPath(); ctx.moveTo(0, h*0.15);
                for (var ax = 0; ax <= w; ax += 15) { ctx.lineTo(ax, h*0.28 + Math.sin(ax*0.012 + t*0.02 + a*0.8) * h*0.08); }
                ctx.lineTo(w, h*0.55); ctx.lineTo(0, h*0.55); ctx.fill(); ctx.restore();
            }
            ctx.fillStyle = '#fff';
            for (var st = 0; st < 100; st++) {
                ctx.globalAlpha = 0.4 + Math.sin(t*0.1 + st) * 0.3;
                ctx.beginPath(); ctx.arc((st * 193.7) % w, (st * 71.3) % (h * 0.55), 1 + (st % 3) * 0.5, 0, Math.PI*2); ctx.fill();
            }
            ctx.globalAlpha = 1;
            ctx.fillStyle = '#1a1a2e'; ctx.beginPath(); ctx.moveTo(0, h); ctx.lineTo(0, h*0.72);
            ctx.lineTo(w*0.12, h*0.52); ctx.lineTo(w*0.28, h*0.68); ctx.lineTo(w*0.48, h*0.38);
            ctx.lineTo(w*0.68, h*0.58); ctx.lineTo(w*0.85, h*0.42); ctx.lineTo(w, h*0.58); ctx.lineTo(w, h); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.beginPath(); ctx.moveTo(w*0.48, h*0.38); ctx.lineTo(w*0.42, h*0.50); ctx.lineTo(w*0.54, h*0.50); ctx.fill();
            ctx.beginPath(); ctx.moveTo(w*0.85, h*0.42); ctx.lineTo(w*0.79, h*0.52); ctx.lineTo(w*0.91, h*0.52); ctx.fill();
            var lake = ctx.createLinearGradient(0, h*0.82, 0, h);
            lake.addColorStop(0, 'rgba(20,50,70,0.9)'); lake.addColorStop(1, 'rgba(10,30,50,0.95)');
            ctx.fillStyle = lake; ctx.fillRect(0, h*0.82, w, h*0.18);
        }
        
        function drawWorship(ctx, w, h, t) {
            var bg = ctx.createLinearGradient(0, 0, 0, h);
            bg.addColorStop(0, '#1a0a30'); bg.addColorStop(0.5, '#2a1a50'); bg.addColorStop(1, '#4a3020');
            ctx.fillStyle = bg; ctx.fillRect(0, 0, w, h);
            for (var i = 0; i < 8; i++) {
                ctx.save(); ctx.globalAlpha = 0.12 + Math.sin(t*0.04 + i) * 0.08;
                var rayX = w * 0.5 + Math.sin(t*0.02 + i*0.8) * w * 0.25;
                var rg = ctx.createLinearGradient(rayX, h, rayX, 0);
                rg.addColorStop(0, 'hsl(' + (280 + i*12) + ',70%,55%)'); rg.addColorStop(1, 'transparent');
                ctx.fillStyle = rg; ctx.beginPath(); ctx.moveTo(rayX - 50, h);
                ctx.lineTo(rayX - 15 + Math.sin(t*0.015)*20, 0); ctx.lineTo(rayX + 15 + Math.sin(t*0.015)*20, 0);
                ctx.lineTo(rayX + 50, h); ctx.fill(); ctx.restore();
            }
            ctx.fillStyle = '#fff';
            for (var s = 0; s < 60; s++) {
                ctx.globalAlpha = 0.4 + Math.sin(t*0.12 + s) * 0.3;
                ctx.beginPath(); ctx.arc((s * 137) % w, (s * 89) % (h*0.6), 1.2, 0, Math.PI*2); ctx.fill();
            }
            ctx.globalAlpha = 1;
            ctx.fillStyle = 'rgba(255,220,150,0.3)';
            ctx.fillRect(w/2 - 10, h*0.45 - 90, 20, 180); ctx.fillRect(w/2 - 60, h*0.45 - 50, 120, 20);
        }
        
        function drawCorporate(ctx, w, h, t) {
            var bg = ctx.createLinearGradient(0, 0, w, h);
            bg.addColorStop(0, '#0a2540'); bg.addColorStop(1, '#0d47a1');
            ctx.fillStyle = bg; ctx.fillRect(0, 0, w, h);
            ctx.strokeStyle = 'rgba(100,200,255,0.15)'; ctx.lineWidth = 1;
            var gridOff = (t * 0.5) % 60;
            for (var gx = -60 + gridOff; gx < w + 60; gx += 60) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, h); ctx.stroke(); }
            for (var gy = 0; gy < h; gy += 60) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(w, gy); ctx.stroke(); }
            for (var b = 0; b < 8; b++) {
                var bh = 60 + Math.abs(Math.sin(t*0.03 + b*0.6)) * 140;
                var bgr = ctx.createLinearGradient(0, h*0.85 - bh, 0, h*0.85);
                bgr.addColorStop(0, '#00e5ff'); bgr.addColorStop(1, '#0066cc');
                ctx.fillStyle = bgr; ctx.fillRect(w*0.1 + b * (w*0.1), h*0.85 - bh, w*0.07, bh);
            }
            ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.05) + 'px Arial'; ctx.textAlign = 'center';
            ctx.fillText('QUARTERLY REPORT', w/2, h*0.15);
        }
        
        function drawSports(ctx, w, h, t) {
            var fg = ctx.createLinearGradient(0, 0, 0, h);
            fg.addColorStop(0, '#1b5e20'); fg.addColorStop(0.5, '#2e7d32'); fg.addColorStop(1, '#1b5e20');
            ctx.fillStyle = fg; ctx.fillRect(0, 0, w, h);
            var mx = w * 0.05, my = h * 0.15, fw = w - 2 * mx, fh = h - 2 * my;
            ctx.fillStyle = '#0033aa'; ctx.fillRect(mx, my, fw * 0.1, fh);
            ctx.fillStyle = '#aa0000'; ctx.fillRect(w - mx - fw * 0.1, my, fw * 0.1, fh);
            ctx.strokeStyle = 'rgba(255,255,255,0.9)'; ctx.lineWidth = 2;
            for (var i = 0; i <= 10; i++) { var x = mx + fw * 0.1 + fw * 0.8 * i / 10; ctx.beginPath(); ctx.moveTo(x, my); ctx.lineTo(x, h - my); ctx.stroke(); }
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.strokeRect(mx, my, fw, fh);
            ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.03) + 'px Arial'; ctx.textAlign = 'center';
            var nums = ['10','20','30','40','50','40','30','20','10'];
            for (var n = 0; n < nums.length; n++) {
                var nx = mx + fw * 0.1 + fw * 0.8 * (n + 1) / 10;
                ctx.fillText(nums[n], nx, my + fh * 0.12); ctx.fillText(nums[n], nx, h - my - fh * 0.05);
            }
            ctx.font = 'bold ' + Math.round(w*0.035) + 'px Arial';
            ctx.fillText('HOME', mx + fw * 0.05, h/2); ctx.fillText('AWAY', w - mx - fw * 0.05, h/2);
            var ballX = w * 0.4 + Math.sin(t * 0.03) * w * 0.2;
            var ballY = h * 0.5 + Math.cos(t * 0.04) * h * 0.15;
            ctx.save(); ctx.translate(ballX, ballY); ctx.rotate(Math.sin(t * 0.05) * 0.3);
            ctx.fillStyle = '#654321'; ctx.beginPath(); ctx.ellipse(0, 0, w*0.025, w*0.015, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, -w*0.012); ctx.lineTo(0, w*0.012); ctx.stroke();
            ctx.restore();
            ctx.fillStyle = 'rgba(0,0,0,0.95)'; ctx.fillRect(w*0.2, h*0.01, w*0.6, h*0.12);
            ctx.strokeStyle = '#ffc107'; ctx.lineWidth = 3; ctx.strokeRect(w*0.2, h*0.01, w*0.6, h*0.12);
            ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.025) + 'px Arial';
            ctx.fillText('HOME', w*0.32, h*0.045); ctx.fillText('AWAY', w*0.68, h*0.045);
            ctx.fillStyle = '#ffcc00'; ctx.fillText('Q4', w*0.5, h*0.045);
            ctx.fillStyle = '#fff'; ctx.font = Math.round(w*0.022) + 'px Arial'; ctx.fillText('2:34', w*0.5, h*0.095);
            ctx.fillStyle = '#00ff00'; ctx.font = 'bold ' + Math.round(w*0.04) + 'px monospace';
            ctx.fillText('24', w*0.32, h*0.1); ctx.fillText('17', w*0.68, h*0.1);
        }
        
        function drawConcert(ctx, w, h, t) {
            ctx.fillStyle = '#080010'; ctx.fillRect(0, 0, w, h);
            var colors = ['#ff00ff','#00ffff','#ffff00','#ff0088','#00ff88','#8800ff'];
            for (var i = 0; i < 10; i++) {
                ctx.save(); ctx.globalAlpha = 0.2 + Math.sin(t*0.06 + i*0.5) * 0.1;
                var ang = Math.sin(t*0.025 + i*0.5) * 0.5;
                var topX = w/2 + Math.tan(ang) * h;
                var lg = ctx.createLinearGradient(w/2, h, topX, 0);
                lg.addColorStop(0, colors[i % colors.length]); lg.addColorStop(1, 'transparent');
                ctx.fillStyle = lg; ctx.beginPath(); ctx.moveTo(w/2, h);
                ctx.lineTo(topX - w*0.06, 0); ctx.lineTo(topX + w*0.06, 0); ctx.closePath(); ctx.fill(); ctx.restore();
            }
            ctx.fillStyle = '#000'; ctx.beginPath(); ctx.moveTo(0, h);
            for (var cx = 0; cx <= w; cx += w*0.02) { ctx.lineTo(cx, h - (h*0.08 + Math.sin(t*0.1 + cx*0.008) * h*0.03)); }
            ctx.lineTo(w, h); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.1) + 'px Arial'; ctx.textAlign = 'center';
            ctx.shadowColor = '#ff00ff'; ctx.shadowBlur = 20 + Math.sin(t*0.1) * 10; ctx.fillText('LIVE', w/2, h*0.35); ctx.shadowBlur = 0;
        }
        
        function drawRetail(ctx, w, h, t) {
            var hue = (t * 0.5) % 360;
            var rg = ctx.createLinearGradient(0, 0, w, h);
            rg.addColorStop(0, 'hsl(' + hue + ',80%,50%)'); rg.addColorStop(0.5, 'hsl(' + ((hue+40)%360) + ',70%,45%)');
            rg.addColorStop(1, 'hsl(' + ((hue+80)%360) + ',75%,40%)');
            ctx.fillStyle = rg; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            for (var sp = 0; sp < 40; sp++) {
                var spx = (Math.sin(t*0.015 + sp*0.5) * 0.4 + 0.5) * w;
                var spy = ((sp * 0.06 + t*0.002) % 1.1) * h;
                ctx.beginPath(); ctx.arc(spx, spy, 3 + Math.sin(t*0.08 + sp) * 2, 0, Math.PI*2); ctx.fill();
            }
            ctx.save(); ctx.translate(w/2, h/2);
            var scale = 1 + Math.sin(t*0.08) * 0.03; ctx.scale(scale, scale);
            ctx.fillStyle = '#d32f2f'; ctx.beginPath(); ctx.moveTo(-w*0.35, 0);
            ctx.lineTo(-w*0.32, -h*0.15); ctx.lineTo(w*0.32, -h*0.15); ctx.lineTo(w*0.35, 0);
            ctx.lineTo(w*0.32, h*0.15); ctx.lineTo(-w*0.32, h*0.15); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.round(w*0.12) + 'px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('SALE', 0, 0); ctx.restore();
            ctx.textBaseline = 'alphabetic'; ctx.font = 'bold ' + Math.round(w*0.04) + 'px Arial'; ctx.fillStyle = '#fff';
            ctx.fillText('UP TO 50% OFF', w/2, h*0.82);
        }
        
        function drawCinema(ctx, w, h, t) {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
            var lbH = h * 0.12, viewH = h - lbH * 2;
            var sky = ctx.createLinearGradient(0, lbH, 0, lbH + viewH * 0.6);
            sky.addColorStop(0, '#1a1a3a'); sky.addColorStop(1, 'hsl(' + (30 + Math.sin(t*0.01)*10) + ',60%,35%)');
            ctx.fillStyle = sky; ctx.fillRect(0, lbH, w, viewH * 0.6);
            var sunY = lbH + viewH*0.3 + Math.sin(t*0.008) * 10;
            var sunGlow = ctx.createRadialGradient(w*0.7, sunY, 0, w*0.7, sunY, w*0.15);
            sunGlow.addColorStop(0, 'rgba(255,200,100,1)'); sunGlow.addColorStop(0.4, 'rgba(255,150,50,0.5)'); sunGlow.addColorStop(1, 'transparent');
            ctx.fillStyle = sunGlow; ctx.fillRect(0, lbH, w, viewH);
            ctx.fillStyle = '#1a1a2a'; ctx.beginPath(); ctx.moveTo(0, lbH + viewH * 0.6);
            ctx.lineTo(w*0.2, lbH + viewH * 0.4); ctx.lineTo(w*0.4, lbH + viewH * 0.55); ctx.lineTo(w*0.6, lbH + viewH * 0.35);
            ctx.lineTo(w*0.8, lbH + viewH * 0.5); ctx.lineTo(w, lbH + viewH * 0.45); ctx.lineTo(w, lbH + viewH); ctx.lineTo(0, lbH + viewH); ctx.fill();
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, lbH); ctx.fillRect(0, h - lbH, w, lbH);
        }
        
        function drawContent(ctx, w, h, t) {
            ctx.clearRect(0, 0, w, h);
            switch(state.genre) {
                case 'worship': drawWorship(ctx, w, h, t); break;
                case 'corporate': drawCorporate(ctx, w, h, t); break;
                case 'sports': drawSports(ctx, w, h, t); break;
                case 'cinema': drawCinema(ctx, w, h, t); break;
                case 'concert': drawConcert(ctx, w, h, t); break;
                case 'retail': drawRetail(ctx, w, h, t); break;
                default: drawNature(ctx, w, h, t);
            }
        }
        
        function resizePreviewCanvas() {
            var container = previewCanvas.parentElement;
            var rect = container.getBoundingClientRect();
            previewCanvas.width = rect.width * 2;
            previewCanvas.height = rect.height * 2;
        }
        
        function animatePreview() {
            frameCount++;
            drawContent(previewCtx, previewCanvas.width, previewCanvas.height, frameCount);
            requestAnimationFrame(animatePreview);
        }
        
        var updateTimeout = null;
        function debouncedUpdate() {
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updateUI, 300);
        }
        
        document.querySelectorAll('[data-shape]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-shape]').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active'); state.shape = btn.dataset.shape;
                var widthSlider = document.getElementById('widthSlider');
                var heightSlider = document.getElementById('heightSlider');
                if (state.shape === 'custom') { heightSlider.disabled = false; }
                else {
                    heightSlider.disabled = true;
                    state.width = WIDTH_INCREMENTS[parseInt(widthSlider.value)];
                    if (state.shape === 'rectangle') state.height = findBestHeightForRatio(state.width, 16/9);
                    else if (state.shape === 'square') state.height = snapToIncrement(state.width, HEIGHT_INCREMENTS);
                    else if (state.shape === 'ultrawide') state.height = findBestHeightForRatio(state.width, 21/9);
                    heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
                }
                debouncedUpdate();
            });
        });
        
        document.querySelectorAll('[data-pitch]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-pitch]').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active'); state.pixelPitch = parseFloat(btn.dataset.pitch); debouncedUpdate();
            });
        });
        
        document.querySelectorAll('[data-genre]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-genre]').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active'); state.genre = btn.dataset.genre; debouncedUpdate();
            });
        });
        
        document.getElementById('widthSlider').addEventListener('input', function(e) {
            state.width = WIDTH_INCREMENTS[parseInt(e.target.value)];
            if (state.shape !== 'custom') {
                var heightSlider = document.getElementById('heightSlider');
                if (state.shape === 'rectangle') state.height = findBestHeightForRatio(state.width, 16/9);
                else if (state.shape === 'square') state.height = snapToIncrement(state.width, HEIGHT_INCREMENTS);
                else if (state.shape === 'ultrawide') state.height = findBestHeightForRatio(state.width, 21/9);
                heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
            }
            debouncedUpdate();
        });
        
        document.getElementById('heightSlider').addEventListener('input', function(e) {
            if (state.shape === 'custom') { state.height = HEIGHT_INCREMENTS[parseInt(e.target.value)]; debouncedUpdate(); }
        });
        
        resizePreviewCanvas();
        window.addEventListener('resize', resizePreviewCanvas);
        updateUI();
        animatePreview();
    </script>
</body>
</html>
