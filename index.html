<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Prestige Visual System - AR LED Video Wall Visualizer</title>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0a0a1a 0%, #0f1a2a 50%, #0a0a0f 100%); color: #fff; -webkit-user-select: none; user-select: none; }
        
        .container { min-height: 100%; padding: 20px; padding-bottom: 100px; }
        
        .header { text-align: center; padding: 30px 0; }
        .logo-text { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #00a8ff, #00ffcc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .logo-subtitle { font-size: 12px; color: rgba(0,200,255,0.7); text-transform: uppercase; letter-spacing: 6px; margin-top: 5px; }
        
        .preview-section { background: rgba(0,0,0,0.4); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,200,255,0.2); }
        .preview-wrapper { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .preview-frame { background: #0a0a0a; padding: 6px; border-radius: 3px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .preview-container { position: relative; overflow: hidden; background: #000; }
        #previewImage { display: block; width: 100%; height: 100%; object-fit: cover; }
        .preview-label { text-align: center; font-size: 12px; color: rgba(255,255,255,0.5); }
        
        .ar-button { display: flex; width: 100%; padding: 18px; font-size: 18px; font-weight: 700; color: #000; background: linear-gradient(135deg, #00ff88, #00d4ff); border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; align-items: center; justify-content: center; gap: 10px; text-decoration: none; }
        .ar-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .ar-button:active { transform: scale(0.98); }
        .ar-button svg { width: 24px; height: 24px; }
        
        .ar-note { text-align: center; font-size: 11px; color: rgba(255,255,255,0.4); margin-bottom: 20px; }
        #arDimensions { color: #00d4ff; font-weight: 600; }
        
        .status-message { text-align: center; padding: 12px; margin-bottom: 15px; border-radius: 10px; font-size: 13px; display: none; }
        .status-message.show { display: block; }
        .status-message.success { background: rgba(0,255,100,0.2); color: #00ff88; border: 1px solid rgba(0,255,100,0.3); }
        .status-message.error { background: rgba(255,50,50,0.2); color: #ff6666; border: 1px solid rgba(255,50,50,0.3); }
        .status-message.info { background: rgba(0,150,255,0.2); color: #00d4ff; border: 1px solid rgba(0,150,255,0.3); }
        
        .config-section { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(0,200,255,0.15); }
        .section-title { font-size: 11px; color: #00d4ff; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; font-weight: 600; }
        
        .pricing-display { text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(0,200,100,0.15), rgba(0,150,255,0.1)); border-radius: 12px; border: 1px solid rgba(0,255,150,0.3); margin-bottom: 15px; }
        .price { font-size: 42px; font-weight: 800; color: #00ff88; }
        .price-details { font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 5px; }
        .price-details span { color: #00d4ff; font-weight: 600; }
        .viewing-distance { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .viewing-distance strong { color: #ffcc00; }
        
        .button-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .option-btn { padding: 10px 6px; background: rgba(0,100,200,0.15); border: 1px solid rgba(0,200,255,0.2); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 11px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
        .option-btn.active { background: rgba(0,150,255,0.4); border-color: #00d4ff; color: #fff; }
        .option-btn .pitch-name { font-size: 12px; font-weight: 700; }
        .option-btn .pitch-label { font-size: 8px; color: rgba(255,255,255,0.4); margin-top: 2px; }
        .option-btn.active .pitch-label { color: rgba(255,255,255,0.7); }
        .option-btn .pitch-res { font-size: 11px; color: #00ff88; font-weight: 700; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); }
        .option-btn.active .pitch-res { color: #00ff88; }
        
        .slider-group { margin-bottom: 15px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .slider-label { font-size: 12px; color: rgba(255,255,255,0.6); }
        .slider-value { font-size: 16px; color: #00d4ff; font-weight: 700; }
        input[type="range"] { width: 100%; height: 8px; -webkit-appearance: none; background: rgba(0,100,200,0.3); border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: linear-gradient(135deg, #00a8ff, #00d4aa); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,200,255,0.4); }
        input[type="range"]:disabled { opacity: 0.4; }
        
        .genre-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px; }
        .genre-btn { padding: 10px 6px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .genre-btn.active { background: #fff; border-color: #fff; color: #0a0a0f; }
        .genre-description { text-align: center; font-size: 11px; color: rgba(0,200,255,0.8); font-style: italic; padding: 5px 0; }
        
        .specs-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .spec-box { background: rgba(0,150,255,0.1); border: 1px solid rgba(0,200,255,0.15); border-radius: 10px; padding: 12px; text-align: center; }
        .spec-label { font-size: 9px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 4px; }
        .spec-value { font-size: 14px; color: #00d4ff; font-weight: 600; }
        
        .disclaimer { font-size: 10px; color: rgba(255,255,255,0.4); text-align: center; line-height: 1.5; padding: 15px; }
        
        #hiddenCanvas { display: none; }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-text">Prestige Visual</div>
            <div class="logo-subtitle">System</div>
        </div>
        
        <div class="preview-section">
            <div class="preview-wrapper">
                <div class="preview-frame">
                    <div class="preview-container" id="previewContainer">
                        <img id="previewImage" src="images/sports.jpg" alt="LED Wall Preview">
                    </div>
                </div>
            </div>
            <div class="preview-label">HD Preview · <span id="arDimensions">13.8 ft × 7.7 ft</span></div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <button class="ar-button" id="generateBtn">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4v6h2V6h4V4H3zm18 0h-6v2h4v4h2V4zm-2 14h-4v2h6v-6h-2v4zM5 18v-4H3v6h6v-2H5zm7-12L5.5 9.5 12 13l6.5-3.5L12 6zm0 8.5l-5.5-3v3L12 18l5.5-3.5v-3L12 14.5z"/></svg>
            View in Your Space
        </button>
        
        <a id="arLink" rel="ar" href="#" download="led-wall.usdz" style="display:none;">
            <img id="arImage">
        </a>
        
        <div class="ar-note">Opens iOS AR viewer with real-world scale</div>
        
        <div class="config-section">
            <div class="section-title">Pricing</div>
            <div class="pricing-display">
                <div class="price" id="priceDisplay">$80,000+</div>
                <div class="price-details">Estimated starting price · <span id="pitchLabel">P1.9 Standard</span></div>
                <div class="viewing-distance">Recommended viewing: <strong id="viewingDistance">15+ feet</strong></div>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Screen Shape</div>
            <div class="button-grid">
                <button class="option-btn active" data-shape="rectangle"><span class="pitch-name">Rectangle</span><div class="pitch-label">16:9</div></button>
                <button class="option-btn" data-shape="square"><span class="pitch-name">Square</span><div class="pitch-label">1:1</div></button>
                <button class="option-btn" data-shape="ultrawide"><span class="pitch-name">Ultrawide</span><div class="pitch-label">21:9</div></button>
                <button class="option-btn" data-shape="custom"><span class="pitch-name">Custom</span><div class="pitch-label">Free</div></button>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Dimensions</div>
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Width</span>
                    <span class="slider-value" id="widthValue">13.8 ft</span>
                </div>
                <input type="range" id="widthSlider" min="0" max="18" value="5" step="1">
            </div>
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Height</span>
                    <span class="slider-value" id="heightValue">7.7 ft</span>
                </div>
                <input type="range" id="heightSlider" min="0" max="17" value="5" step="1">
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Pixel Pitch</div>
            <div class="button-grid" id="pitchGrid">
                <button class="option-btn" data-pitch="0.9">
                    <span class="pitch-name">0.9mm</span>
                    <div class="pitch-label">Ultra-Premium</div>
                    <div class="pitch-res" id="res-0.9">4K+</div>
                </button>
                <button class="option-btn" data-pitch="1.25">
                    <span class="pitch-name">1.25mm</span>
                    <div class="pitch-label">Premium</div>
                    <div class="pitch-res" id="res-1.25">3K+</div>
                </button>
                <button class="option-btn active" data-pitch="1.9">
                    <span class="pitch-name">1.9mm</span>
                    <div class="pitch-label">Standard</div>
                    <div class="pitch-res" id="res-1.9">2K+</div>
                </button>
                <button class="option-btn" data-pitch="2.6">
                    <span class="pitch-name">2.6mm</span>
                    <div class="pitch-label">Commercial</div>
                    <div class="pitch-res" id="res-2.6">HD+</div>
                </button>
            </div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Content Preview</div>
            <div class="genre-grid">
                <button class="genre-btn" data-genre="worship">Worship</button>
                <button class="genre-btn" data-genre="corporate">Corporate</button>
                <button class="genre-btn active" data-genre="sports">Sports</button>
                <button class="genre-btn" data-genre="concert">Concert</button>
            </div>
            <div class="genre-description" id="genreDescription">Sports Bars & Watch Parties</div>
        </div>
        
        <div class="config-section">
            <div class="section-title">Specifications</div>
            <div class="specs-row">
                <div class="spec-box"><div class="spec-label">Resolution</div><div class="spec-value" id="resolutionSpec">2252 x 1267</div></div>
                <div class="spec-box"><div class="spec-label">Total Pixels</div><div class="spec-value" id="pixelsSpec">2.85M</div></div>
                <div class="spec-box"><div class="spec-label">Area</div><div class="spec-value" id="areaSpec">106 sq ft</div></div>
            </div>
        </div>
        
        <div class="disclaimer">
            Pricing is an estimate based on selected dimensions. Actual panel configurations and final pricing confirmed during consultation.
        </div>
    </div>
    
    <canvas id="hiddenCanvas"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { USDZExporter } from 'three/addons/exporters/USDZExporter.js';
        
        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = `status-message show ${type}`;
            if (type === 'success') {
                setTimeout(() => { status.className = 'status-message'; }, 3000);
            }
        }
        
        // ===================== CONFIG =====================
        const IMAGE_PATHS = {
            sports: 'images/sports.jpg',
            worship: 'images/worship.jpg',
            corporate: 'images/corporate.jpg',
            concert: 'images/concert.jpg'
        };
        
        const GENRES = {
            worship: { label: 'Worship', description: 'Churches & Houses of Worship' },
            corporate: { label: 'Corporate', description: 'Lobbies & Boardrooms' },
            sports: { label: 'Sports', description: 'Sports Bars & Watch Parties' },
            concert: { label: 'Concert', description: 'Live Events & Nightclubs' }
        };
        
        const WIDTH_INCREMENTS = [3.9, 5.9, 7.9, 9.8, 11.8, 13.8, 15.7, 17.7, 19.7, 21.7, 23.6, 25.6, 27.6, 29.5, 31.5, 33.5, 35.4, 37.4, 39.4];
        const HEIGHT_INCREMENTS = [2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.9, 10.0, 11.1, 12.2, 13.3, 14.4, 15.5, 16.6, 17.7, 18.9, 20.0, 21.1];
        
        const PITCH_OPTIONS = [0.9, 1.25, 1.9, 2.6];
        
        const PRICING = {
            'P0.9':  { costPerSqft: 385, minViewingFt: 7,  label: 'Ultra-Premium' },
            'P1.25': { costPerSqft: 212, minViewingFt: 10, label: 'Premium' },
            'P1.9':  { costPerSqft: 185, minViewingFt: 15, label: 'Standard' },
            'P2.6':  { costPerSqft: 140, minViewingFt: 21, label: 'Commercial' }
        };
        
        const MARGIN_DIVISOR = 0.218;
        const FT_TO_M = 0.3048;
        
        // ===================== STATE =====================
        const state = {
            shape: 'rectangle',
            width: 13.8,
            height: 7.7,
            pixelPitch: 1.9,
            genre: 'sports'
        };
        
        // ===================== IMAGE LOADING =====================
        const loadedImages = {};
        const previewImage = document.getElementById('previewImage');
        const previewContainer = document.getElementById('previewContainer');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const hiddenCtx = hiddenCanvas.getContext('2d');
        
        function loadImage(genre) {
            return new Promise((resolve) => {
                if (loadedImages[genre] && loadedImages[genre].complete) {
                    resolve(loadedImages[genre]);
                    return;
                }
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    loadedImages[genre] = img;
                    resolve(img);
                };
                img.onerror = () => {
                    console.error('Failed to load image:', genre);
                    resolve(null);
                };
                img.src = IMAGE_PATHS[genre];
            });
        }
        
        // Preload all images immediately
        async function preloadAllImages() {
            const promises = Object.keys(IMAGE_PATHS).map(genre => loadImage(genre));
            await Promise.all(promises);
            console.log('All images preloaded');
        }
        preloadAllImages();
        
        // ===================== HELPERS =====================
        function snapToIncrement(value, increments) {
            return increments.reduce((prev, curr) => 
                Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev
            );
        }
        
        function getIncrementIndex(value, increments) {
            for (let i = 0; i < increments.length; i++) {
                if (Math.abs(increments[i] - value) < 0.1) return i;
            }
            return 0;
        }
        
        function findBestHeightForRatio(width, targetRatio) {
            return snapToIncrement(width / targetRatio, HEIGHT_INCREMENTS);
        }
        
        function getPitchKey(pitch) {
            if (pitch === 0.9) return 'P0.9';
            if (pitch === 1.25) return 'P1.25';
            if (pitch === 1.9) return 'P1.9';
            if (pitch === 2.6) return 'P2.6';
            return 'P1.9';
        }
        
        function getCostPerSqft(sqft, pitchKey) {
            const baseCost = PRICING[pitchKey].costPerSqft;
            if (sqft >= 175) return baseCost * 0.78;
            if (sqft >= 120) return baseCost * 0.85;
            if (sqft >= 80) return baseCost * 0.92;
            return baseCost;
        }
        
        function calculateDisplayPrice(width, height, pitch) {
            const key = getPitchKey(pitch);
            const sqft = width * height;
            const cost = getCostPerSqft(sqft, key) * sqft;
            return Math.floor((cost / MARGIN_DIVISOR) / 10000) * 10000;
        }
        
        function formatPrice(price) {
            if (price < 10000) price = 10000;
            return '$' + price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '+';
        }
        
        function calcResolutionForPitch(widthFt, heightFt, pitchMM) {
            const wMM = widthFt * 304.8;
            const hMM = heightFt * 304.8;
            return { w: Math.round(wMM / pitchMM), h: Math.round(hMM / pitchMM) };
        }
        
        // Calculate equivalent resolution label (2K, 3K, 4K, etc.)
        function getResolutionLabel(horizontalPixels) {
            if (horizontalPixels >= 7680) return '8K';
            if (horizontalPixels >= 6144) return '6K+';
            if (horizontalPixels >= 5120) return '5K+';
            if (horizontalPixels >= 4096) return '4K+';
            if (horizontalPixels >= 3840) return '4K';
            if (horizontalPixels >= 3072) return '3K+';
            if (horizontalPixels >= 2560) return '3K';
            if (horizontalPixels >= 2048) return '2K+';
            if (horizontalPixels >= 1920) return '2K';
            if (horizontalPixels >= 1280) return 'HD+';
            return 'HD';
        }
        
        // ===================== UI =====================
        function updatePreviewSize() {
            const maxWidth = 320;
            const aspect = state.width / state.height;
            let w = maxWidth;
            let h = Math.round(w / aspect);
            
            if (h > 220) {
                h = 220;
                w = Math.round(h * aspect);
            }
            
            previewContainer.style.width = w + 'px';
            previewContainer.style.height = h + 'px';
        }
        
        function updatePitchResolutions() {
            // Update resolution label in each pitch button based on current dimensions
            PITCH_OPTIONS.forEach(pitch => {
                const res = calcResolutionForPitch(state.width, state.height, pitch);
                const label = getResolutionLabel(res.w);
                const el = document.getElementById(`res-${pitch}`);
                if (el) {
                    el.textContent = label;
                }
            });
        }
        
        function updateUI() {
            document.getElementById('widthValue').textContent = state.width + ' ft';
            document.getElementById('heightValue').textContent = state.height + ' ft';
            
            const price = calculateDisplayPrice(state.width, state.height, state.pixelPitch);
            const key = getPitchKey(state.pixelPitch);
            document.getElementById('priceDisplay').textContent = formatPrice(price);
            document.getElementById('pitchLabel').textContent = key + ' ' + PRICING[key].label;
            document.getElementById('viewingDistance').textContent = PRICING[key].minViewingFt + '+ feet';
            
            const res = calcResolutionForPitch(state.width, state.height, state.pixelPitch);
            const total = res.w * res.h;
            const sqft = Math.round(state.width * state.height);
            document.getElementById('resolutionSpec').textContent = res.w + ' x ' + res.h;
            document.getElementById('pixelsSpec').textContent = total >= 1000000 ? (total / 1000000).toFixed(2) + 'M' : Math.round(total / 1000) + 'K';
            document.getElementById('areaSpec').textContent = sqft + ' sq ft';
            
            document.getElementById('genreDescription').textContent = GENRES[state.genre].description;
            document.getElementById('arDimensions').textContent = state.width + ' ft × ' + state.height + ' ft';
            
            // Update all pitch button resolution labels
            updatePitchResolutions();
            
            // Update preview image and size
            previewImage.src = IMAGE_PATHS[state.genre];
            updatePreviewSize();
        }
        
        // ===================== TEXTURE GENERATION =====================
        async function generateTexture() {
            // Wait for image to load
            const img = await loadImage(state.genre);
            
            const textureSize = 2048;
            const aspectRatio = state.width / state.height;
            const texW = textureSize;
            const texH = Math.round(textureSize / aspectRatio);
            
            hiddenCanvas.width = texW;
            hiddenCanvas.height = texH;
            
            // Fill black background
            hiddenCtx.fillStyle = '#000';
            hiddenCtx.fillRect(0, 0, texW, texH);
            
            if (img && img.complete && img.naturalWidth > 0) {
                // Center crop the image to match wall aspect ratio
                const imgAspect = img.width / img.height;
                const targetAspect = aspectRatio;
                
                let sx, sy, sw, sh;
                
                if (imgAspect > targetAspect) {
                    // Image is wider - crop sides
                    sh = img.height;
                    sw = img.height * targetAspect;
                    sx = (img.width - sw) / 2;
                    sy = 0;
                } else {
                    // Image is taller - crop top/bottom
                    sw = img.width;
                    sh = img.width / targetAspect;
                    sx = 0;
                    sy = (img.height - sh) / 2;
                }
                
                hiddenCtx.drawImage(img, sx, sy, sw, sh, 0, 0, texW, texH);
                console.log('Drew image to texture canvas:', texW, 'x', texH);
            } else {
                console.warn('Image not ready, using fallback color');
                // Fallback: draw a gradient if image fails
                const gradient = hiddenCtx.createLinearGradient(0, 0, texW, texH);
                gradient.addColorStop(0, '#1a5a1a');
                gradient.addColorStop(1, '#0a3a0a');
                hiddenCtx.fillStyle = gradient;
                hiddenCtx.fillRect(0, 0, texW, texH);
                
                hiddenCtx.fillStyle = '#fff';
                hiddenCtx.font = 'bold 120px Arial';
                hiddenCtx.textAlign = 'center';
                hiddenCtx.fillText('PRESTIGE', texW/2, texH/2);
            }
            
            return hiddenCanvas;
        }
        
        // ===================== AR GENERATION =====================
        async function generateAndLaunchAR() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="30 60"/></svg> Generating...';
            showStatus('Loading image...', 'info');
            
            try {
                // Ensure image is loaded first
                await loadImage(state.genre);
                
                showStatus('Creating 3D model...', 'info');
                
                // Generate texture
                const textureCanvas = await generateTexture();
                
                // Create data URL from canvas for debugging
                const dataUrl = textureCanvas.toDataURL('image/jpeg', 0.9);
                console.log('Texture generated, size:', textureCanvas.width, 'x', textureCanvas.height);
                
                // Create scene
                const scene = new THREE.Scene();
                
                const widthM = state.width * FT_TO_M;
                const heightM = state.height * FT_TO_M;
                const depth = 0.08; // ~3 inch depth
                
                // Create texture from canvas
                const texture = new THREE.CanvasTexture(textureCanvas);
                texture.colorSpace = THREE.SRGBColorSpace;
                texture.needsUpdate = true;
                
                // Screen - MeshBasicMaterial for reliable USDZ export
                const screenGeo = new THREE.PlaneGeometry(widthM, heightM);
                const screenMat = new THREE.MeshBasicMaterial({ 
                    map: texture,
                    side: THREE.FrontSide
                });
                const screen = new THREE.Mesh(screenGeo, screenMat);
                screen.position.z = depth / 2 + 0.003;
                
                // Frame (black cabinet)
                const frameGeo = new THREE.BoxGeometry(widthM + 0.05, heightM + 0.05, depth);
                const frameMat = new THREE.MeshStandardMaterial({ 
                    color: 0x111111, 
                    roughness: 0.7, 
                    metalness: 0.3 
                });
                const frame = new THREE.Mesh(frameGeo, frameMat);
                
                // Group
                const group = new THREE.Group();
                group.add(frame);
                group.add(screen);
                scene.add(group);
                
                // Lights
                scene.add(new THREE.AmbientLight(0xffffff, 2));
                
                // Export
                const exporter = new USDZExporter();
                const arrayBuffer = await exporter.parse(scene);
                
                const blob = new Blob([arrayBuffer], { type: 'model/vnd.usdz+zip' });
                const url = URL.createObjectURL(blob);
                
                const arLink = document.getElementById('arLink');
                arLink.href = url;
                
                const arImg = document.getElementById('arImage');
                arImg.src = dataUrl; // Use the actual texture as the AR link image
                
                showStatus('Opening AR viewer...', 'success');
                
                setTimeout(() => arLink.click(), 100);
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4v6h2V6h4V4H3zm18 0h-6v2h4v4h2V4zm-2 14h-4v2h6v-6h-2v4zM5 18v-4H3v6h6v-2H5zm7-12L5.5 9.5 12 13l6.5-3.5L12 6zm0 8.5l-5.5-3v3L12 18l5.5-3.5v-3L12 14.5z"/></svg> View in Your Space';
                    URL.revokeObjectURL(url);
                }, 5000);
                
            } catch (error) {
                console.error('AR Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 4v6h2V6h4V4H3zm18 0h-6v2h4v4h2V4zm-2 14h-4v2h6v-6h-2v4zM5 18v-4H3v6h6v-2H5zm7-12L5.5 9.5 12 13l6.5-3.5L12 6zm0 8.5l-5.5-3v3L12 18l5.5-3.5v-3L12 14.5z"/></svg> View in Your Space';
            }
        }
        
        // ===================== EVENT HANDLERS =====================
        document.querySelectorAll('[data-shape]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-shape]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.shape = btn.dataset.shape;
                
                const widthSlider = document.getElementById('widthSlider');
                const heightSlider = document.getElementById('heightSlider');
                
                if (state.shape === 'custom') {
                    heightSlider.disabled = false;
                } else {
                    heightSlider.disabled = true;
                    const widthIdx = parseInt(widthSlider.value);
                    state.width = WIDTH_INCREMENTS[widthIdx];
                    
                    if (state.shape === 'rectangle') {
                        state.height = findBestHeightForRatio(state.width, 16/9);
                    } else if (state.shape === 'square') {
                        state.height = snapToIncrement(state.width, HEIGHT_INCREMENTS);
                    } else if (state.shape === 'ultrawide') {
                        state.height = findBestHeightForRatio(state.width, 21/9);
                    }
                    heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
                }
                updateUI();
            });
        });
        
        document.querySelectorAll('[data-pitch]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-pitch]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.pixelPitch = parseFloat(btn.dataset.pitch);
                updateUI();
            });
        });
        
        document.querySelectorAll('[data-genre]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-genre]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.genre = btn.dataset.genre;
                updateUI();
            });
        });
        
        document.getElementById('widthSlider').addEventListener('input', (e) => {
            const idx = parseInt(e.target.value);
            state.width = WIDTH_INCREMENTS[idx];
            
            if (state.shape !== 'custom') {
                const heightSlider = document.getElementById('heightSlider');
                if (state.shape === 'rectangle') {
                    state.height = findBestHeightForRatio(state.width, 16/9);
                } else if (state.shape === 'square') {
                    state.height = snapToIncrement(state.width, HEIGHT_INCREMENTS);
                } else if (state.shape === 'ultrawide') {
                    state.height = findBestHeightForRatio(state.width, 21/9);
                }
                heightSlider.value = getIncrementIndex(state.height, HEIGHT_INCREMENTS);
            }
            updateUI();
        });
        
        document.getElementById('heightSlider').addEventListener('input', (e) => {
            if (state.shape === 'custom') {
                state.height = HEIGHT_INCREMENTS[parseInt(e.target.value)];
                updateUI();
            }
        });
        
        document.getElementById('generateBtn').addEventListener('click', generateAndLaunchAR);
        
        // ===================== INIT =====================
        updateUI();
    </script>
</body>
</html>
